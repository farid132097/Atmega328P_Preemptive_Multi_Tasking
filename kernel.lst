   1               	# 1 "kernel.S"
   1               	
   0               	
   0               	
   2               	
   3               	 ; File          : kernel.S
   4               	 ; Author        : MD. Faridul Islam (faridmdislam@gmail.com)
   5               	 ; Description   : AVR kernel for bare-metal RTOS
   6               	 ; Created       : Jul 27, 2025, 09:30 PM
   7               	 ; Last Modified : Dec 08, 2025, 12:19 AM
   8               	
   9               	
  10               	
  11               	
  12               	#include <avr/io.h>
   1               	/* Copyright (c) 2002,2003,2005,2006,2007 Marek Michalkiewicz, Joerg Wunsch
   2               	   Copyright (c) 2007 Eric B. Weddington
   3               	   All rights reserved.
   4               	
   5               	   Redistribution and use in source and binary forms, with or without
   6               	   modification, are permitted provided that the following conditions are met:
   7               	
   8               	   * Redistributions of source code must retain the above copyright
   9               	     notice, this list of conditions and the following disclaimer.
  10               	
  11               	   * Redistributions in binary form must reproduce the above copyright
  12               	     notice, this list of conditions and the following disclaimer in
  13               	     the documentation and/or other materials provided with the
  14               	     distribution.
  15               	
  16               	   * Neither the name of the copyright holders nor the names of
  17               	     contributors may be used to endorse or promote products derived
  18               	     from this software without specific prior written permission.
  19               	
  20               	  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
  21               	  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
  22               	  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
  23               	  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
  24               	  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
  25               	  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
  26               	  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
  27               	  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
  28               	  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
  29               	  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
  30               	  POSSIBILITY OF SUCH DAMAGE. */
  31               	
  32               	/* $Id: io.h,v 1.52.2.28 2009/12/20 17:02:53 arcanum Exp $ */
  33               	
  34               	/** \file */
  35               	/** \defgroup avr_io <avr/io.h>: AVR device-specific IO definitions
  36               	    \code #include <avr/io.h> \endcode
  37               	
  38               	    This header file includes the apropriate IO definitions for the
  39               	    device that has been specified by the <tt>-mmcu=</tt> compiler
  40               	    command-line switch.  This is done by diverting to the appropriate
  41               	    file <tt>&lt;avr/io</tt><em>XXXX</em><tt>.h&gt;</tt> which should
  42               	    never be included directly.  Some register names common to all
  43               	    AVR devices are defined directly within <tt>&lt;avr/common.h&gt;</tt>,
  44               	    which is included in <tt>&lt;avr/io.h&gt;</tt>,
  45               	    but most of the details come from the respective include file.
  46               	
  47               	    Note that this file always includes the following files:
  48               	    \code 
  49               	    #include <avr/sfr_defs.h>
  50               	    #include <avr/portpins.h>
  51               	    #include <avr/common.h>
  52               	    #include <avr/version.h>
  53               	    \endcode
  54               	    See \ref avr_sfr for more details about that header file.
  55               	
  56               	    Included are definitions of the IO register set and their
  57               	    respective bit values as specified in the Atmel documentation.
  58               	    Note that inconsistencies in naming conventions,
  59               	    so even identical functions sometimes get different names on
  60               	    different devices.
  61               	
  62               	    Also included are the specific names useable for interrupt
  63               	    function definitions as documented
  64               	    \ref avr_signames "here".
  65               	
  66               	    Finally, the following macros are defined:
  67               	
  68               	    - \b RAMEND
  69               	    <br>
  70               	    The last on-chip RAM address.
  71               	    <br>
  72               	    - \b XRAMEND
  73               	    <br>
  74               	    The last possible RAM location that is addressable. This is equal to 
  75               	    RAMEND for devices that do not allow for external RAM. For devices 
  76               	    that allow external RAM, this will be larger than RAMEND.
  77               	    <br>
  78               	    - \b E2END
  79               	    <br>
  80               	    The last EEPROM address.
  81               	    <br>
  82               	    - \b FLASHEND
  83               	    <br>
  84               	    The last byte address in the Flash program space.
  85               	    <br>
  86               	    - \b SPM_PAGESIZE
  87               	    <br>
  88               	    For devices with bootloader support, the flash pagesize
  89               	    (in bytes) to be used for the \c SPM instruction. 
  90               	    - \b E2PAGESIZE
  91               	    <br>
  92               	    The size of the EEPROM page.
  93               	    
  94               	*/
  95               	
  96               	#ifndef _AVR_IO_H_
  97               	#define _AVR_IO_H_
  98               	
  99               	#include <avr/sfr_defs.h>
   1               	/* Copyright (c) 2002, Marek Michalkiewicz <marekm@amelek.gda.pl>
 100               	
 101               	#if defined (__AVR_AT94K__)
 102               	#  include <avr/ioat94k.h>
 103               	#elif defined (__AVR_AT43USB320__)
 104               	#  include <avr/io43u32x.h>
 105               	#elif defined (__AVR_AT43USB355__)
 106               	#  include <avr/io43u35x.h>
 107               	#elif defined (__AVR_AT76C711__)
 108               	#  include <avr/io76c711.h>
 109               	#elif defined (__AVR_AT86RF401__)
 110               	#  include <avr/io86r401.h>
 111               	#elif defined (__AVR_AT90PWM1__)
 112               	#  include <avr/io90pwm1.h>
 113               	#elif defined (__AVR_AT90PWM2__)
 114               	#  include <avr/io90pwmx.h>
 115               	#elif defined (__AVR_AT90PWM2B__)
 116               	#  include <avr/io90pwm2b.h>
 117               	#elif defined (__AVR_AT90PWM3__)
 118               	#  include <avr/io90pwmx.h>
 119               	#elif defined (__AVR_AT90PWM3B__)
 120               	#  include <avr/io90pwm3b.h>
 121               	#elif defined (__AVR_AT90PWM216__)
 122               	#  include <avr/io90pwm216.h>
 123               	#elif defined (__AVR_AT90PWM316__)
 124               	#  include <avr/io90pwm316.h>
 125               	#elif defined (__AVR_AT90PWM81__)
 126               	#  include <avr/io90pwm81.h>
 127               	#elif defined (__AVR_ATmega8U2__)
 128               	#  include <avr/iom8u2.h>
 129               	#elif defined (__AVR_ATmega16M1__)
 130               	#  include <avr/iom16m1.h>
 131               	#elif defined (__AVR_ATmega16U2__)
 132               	#  include <avr/iom16u2.h>
 133               	#elif defined (__AVR_ATmega16U4__)
 134               	#  include <avr/iom16u4.h>
 135               	#elif defined (__AVR_ATmega32C1__)
 136               	#  include <avr/iom32c1.h>
 137               	#elif defined (__AVR_ATmega32M1__)
 138               	#  include <avr/iom32m1.h>
 139               	#elif defined (__AVR_ATmega32U2__)
 140               	#  include <avr/iom32u2.h>
 141               	#elif defined (__AVR_ATmega32U4__)
 142               	#  include <avr/iom32u4.h>
 143               	#elif defined (__AVR_ATmega32U6__)
 144               	#  include <avr/iom32u6.h>
 145               	#elif defined (__AVR_ATmega64C1__)
 146               	#  include <avr/iom64c1.h>
 147               	#elif defined (__AVR_ATmega64M1__)
 148               	#  include <avr/iom64m1.h>
 149               	#elif defined (__AVR_ATmega128__)
 150               	#  include <avr/iom128.h>
 151               	#elif defined (__AVR_ATmega1280__)
 152               	#  include <avr/iom1280.h>
 153               	#elif defined (__AVR_ATmega1281__)
 154               	#  include <avr/iom1281.h>
 155               	#elif defined (__AVR_ATmega1284P__)
 156               	#  include <avr/iom1284p.h>
 157               	#elif defined (__AVR_ATmega128RFA1__)
 158               	#  include <avr/iom128rfa1.h>
 159               	#elif defined (__AVR_ATmega2560__)
 160               	#  include <avr/iom2560.h>
 161               	#elif defined (__AVR_ATmega2561__)
 162               	#  include <avr/iom2561.h>
 163               	#elif defined (__AVR_AT90CAN32__)
 164               	#  include <avr/iocan32.h>
 165               	#elif defined (__AVR_AT90CAN64__)
 166               	#  include <avr/iocan64.h>
 167               	#elif defined (__AVR_AT90CAN128__)
 168               	#  include <avr/iocan128.h>
 169               	#elif defined (__AVR_AT90USB82__)
 170               	#  include <avr/iousb82.h>
 171               	#elif defined (__AVR_AT90USB162__)
 172               	#  include <avr/iousb162.h>
 173               	#elif defined (__AVR_AT90USB646__)
 174               	#  include <avr/iousb646.h>
 175               	#elif defined (__AVR_AT90USB647__)
 176               	#  include <avr/iousb647.h>
 177               	#elif defined (__AVR_AT90USB1286__)
 178               	#  include <avr/iousb1286.h>
 179               	#elif defined (__AVR_AT90USB1287__)
 180               	#  include <avr/iousb1287.h>
 181               	#elif defined (__AVR_ATmega64__)
 182               	#  include <avr/iom64.h>
 183               	#elif defined (__AVR_ATmega640__)
 184               	#  include <avr/iom640.h>
 185               	#elif defined (__AVR_ATmega644__) || defined (__AVR_ATmega644A__)
 186               	#  include <avr/iom644.h>
 187               	#elif defined (__AVR_ATmega644P__)
 188               	#  include <avr/iom644p.h>
 189               	#elif defined (__AVR_ATmega644PA__)
 190               	#  include <avr/iom644pa.h>
 191               	#elif defined (__AVR_ATmega645__) || defined (__AVR_ATmega645A__) || defined (__AVR_ATmega645P__)
 192               	#  include <avr/iom645.h>
 193               	#elif defined (__AVR_ATmega6450__) || defined (__AVR_ATmega6450A__) || defined (__AVR_ATmega6450P__
 194               	#  include <avr/iom6450.h>
 195               	#elif defined (__AVR_ATmega649__) || defined (__AVR_ATmega649A__)
 196               	#  include <avr/iom649.h>
 197               	#elif defined (__AVR_ATmega6490__) || defined (__AVR_ATmega6490A__) || defined (__AVR_ATmega6490P__
 198               	#  include <avr/iom6490.h>
 199               	#elif defined (__AVR_ATmega649P__)
 200               	#  include <avr/iom649p.h>
 201               	#elif defined (__AVR_ATmega64HVE__)
 202               	#  include <avr/iom64hve.h>
 203               	#elif defined (__AVR_ATmega103__)
 204               	#  include <avr/iom103.h>
 205               	#elif defined (__AVR_ATmega32__)
 206               	#  include <avr/iom32.h>
 207               	#elif defined (__AVR_ATmega323__)
 208               	#  include <avr/iom323.h>
 209               	#elif defined (__AVR_ATmega324P__) || defined (__AVR_ATmega324A__)
 210               	#  include <avr/iom324.h>
 211               	#elif defined (__AVR_ATmega324PA__)
 212               	#  include <avr/iom324pa.h>
 213               	#elif defined (__AVR_ATmega325__)
 214               	#  include <avr/iom325.h>
 215               	#elif defined (__AVR_ATmega325P__)
 216               	#  include <avr/iom325.h>
 217               	#elif defined (__AVR_ATmega3250__)
 218               	#  include <avr/iom3250.h>
 219               	#elif defined (__AVR_ATmega3250P__)
 220               	#  include <avr/iom3250.h>
 221               	#elif defined (__AVR_ATmega328P__) || defined (__AVR_ATmega328__)
 222               	#  include <avr/iom328p.h>
   1               	/* Copyright (c) 2007 Atmel Corporation
 223               	#elif defined (__AVR_ATmega329__)
 224               	#  include <avr/iom329.h>
 225               	#elif defined (__AVR_ATmega329P__) || defined (__AVR_ATmega329PA__)
 226               	#  include <avr/iom329.h>
 227               	#elif defined (__AVR_ATmega3290__)
 228               	#  include <avr/iom3290.h>
 229               	#elif defined (__AVR_ATmega3290P__)
 230               	#  include <avr/iom3290.h>
 231               	#elif defined (__AVR_ATmega32HVB__)
 232               	#  include <avr/iom32hvb.h>
 233               	#elif defined (__AVR_ATmega406__)
 234               	#  include <avr/iom406.h>
 235               	#elif defined (__AVR_ATmega16__)
 236               	#  include <avr/iom16.h>
 237               	#elif defined (__AVR_ATmega16A__)
 238               	#  include <avr/iom16a.h>
 239               	#elif defined (__AVR_ATmega161__)
 240               	#  include <avr/iom161.h>
 241               	#elif defined (__AVR_ATmega162__)
 242               	#  include <avr/iom162.h>
 243               	#elif defined (__AVR_ATmega163__)
 244               	#  include <avr/iom163.h>
 245               	#elif defined (__AVR_ATmega164P__) || defined (__AVR_ATmega164A__)
 246               	#  include <avr/iom164.h>
 247               	#elif defined (__AVR_ATmega165__) || defined (__AVR_ATmega165A__)
 248               	#  include <avr/iom165.h>
 249               	#elif defined (__AVR_ATmega165P__)
 250               	#  include <avr/iom165p.h>
 251               	#elif defined (__AVR_ATmega168__) || defined (__AVR_ATmega168A__)
 252               	#  include <avr/iom168.h>
 253               	#elif defined (__AVR_ATmega168P__)
 254               	#  include <avr/iom168p.h>
 255               	#elif defined (__AVR_ATmega169__) || defined (__AVR_ATmega169A__)
 256               	#  include <avr/iom169.h>
 257               	#elif defined (__AVR_ATmega169P__)
 258               	#  include <avr/iom169p.h>
 259               	#elif defined (__AVR_ATmega169PA__)
 260               	#  include <avr/iom169pa.h>
 261               	#elif defined (__AVR_ATmega8HVA__)
 262               	#  include <avr/iom8hva.h>
 263               	#elif defined (__AVR_ATmega16HVA__)
 264               	#  include <avr/iom16hva.h>
 265               	#elif defined (__AVR_ATmega16HVA2__)
 266               	#  include <avr/iom16hva2.h>
 267               	#elif defined (__AVR_ATmega16HVB__)
 268               	#  include <avr/iom16hvb.h>
 269               	#elif defined (__AVR_ATmega8__)
 270               	#  include <avr/iom8.h>
 271               	#elif defined (__AVR_ATmega48__) || defined (__AVR_ATmega48A__)
 272               	#  include <avr/iom48.h>
 273               	#elif defined (__AVR_ATmega48P__)
 274               	#  include <avr/iom48p.h>
 275               	#elif defined (__AVR_ATmega88__) || defined (__AVR_ATmega88A__)
 276               	#  include <avr/iom88.h>
 277               	#elif defined (__AVR_ATmega88P__)
 278               	#  include <avr/iom88p.h>
 279               	#elif defined (__AVR_ATmega88PA__)
 280               	#  include <avr/iom88pa.h>
 281               	#elif defined (__AVR_ATmega8515__)
 282               	#  include <avr/iom8515.h>
 283               	#elif defined (__AVR_ATmega8535__)
 284               	#  include <avr/iom8535.h>
 285               	#elif defined (__AVR_AT90S8535__)
 286               	#  include <avr/io8535.h>
 287               	#elif defined (__AVR_AT90C8534__)
 288               	#  include <avr/io8534.h>
 289               	#elif defined (__AVR_AT90S8515__)
 290               	#  include <avr/io8515.h>
 291               	#elif defined (__AVR_AT90S4434__)
 292               	#  include <avr/io4434.h>
 293               	#elif defined (__AVR_AT90S4433__)
 294               	#  include <avr/io4433.h>
 295               	#elif defined (__AVR_AT90S4414__)
 296               	#  include <avr/io4414.h>
 297               	#elif defined (__AVR_ATtiny22__)
 298               	#  include <avr/iotn22.h>
 299               	#elif defined (__AVR_ATtiny26__)
 300               	#  include <avr/iotn26.h>
 301               	#elif defined (__AVR_AT90S2343__)
 302               	#  include <avr/io2343.h>
 303               	#elif defined (__AVR_AT90S2333__)
 304               	#  include <avr/io2333.h>
 305               	#elif defined (__AVR_AT90S2323__)
 306               	#  include <avr/io2323.h>
 307               	#elif defined (__AVR_AT90S2313__)
 308               	#  include <avr/io2313.h>
 309               	#elif defined (__AVR_ATtiny2313__)
 310               	#  include <avr/iotn2313.h>
 311               	#elif defined (__AVR_ATtiny2313A__)
 312               	#  include <avr/iotn2313a.h>
 313               	#elif defined (__AVR_ATtiny13__)
 314               	#  include <avr/iotn13.h>
 315               	#elif defined (__AVR_ATtiny13A__)
 316               	#  include <avr/iotn13a.h>
 317               	#elif defined (__AVR_ATtiny25__)
 318               	#  include <avr/iotn25.h>
 319               	#elif defined (__AVR_ATtiny4313__)
 320               	#  include <avr/iotn4313.h>
 321               	#elif defined (__AVR_ATtiny45__)
 322               	#  include <avr/iotn45.h>
 323               	#elif defined (__AVR_ATtiny85__)
 324               	#  include <avr/iotn85.h>
 325               	#elif defined (__AVR_ATtiny24__)
 326               	#  include <avr/iotn24.h>
 327               	#elif defined (__AVR_ATtiny24A__)
 328               	#  include <avr/iotn24a.h>
 329               	#elif defined (__AVR_ATtiny44__)
 330               	#  include <avr/iotn44.h>
 331               	#elif defined (__AVR_ATtiny44A__)
 332               	#  include <avr/iotn44a.h>
 333               	#elif defined (__AVR_ATtiny84__)
 334               	#  include <avr/iotn84.h>
 335               	#elif defined (__AVR_ATtiny261__)
 336               	#  include <avr/iotn261.h>
 337               	#elif defined (__AVR_ATtiny261A__)
 338               	#  include <avr/iotn261a.h>
 339               	#elif defined (__AVR_ATtiny461__)
 340               	#  include <avr/iotn461.h>
 341               	#elif defined (__AVR_ATtiny461A__)
 342               	#  include <avr/iotn461a.h>
 343               	#elif defined (__AVR_ATtiny861__)
 344               	#  include <avr/iotn861.h>
 345               	#elif defined (__AVR_ATtiny861A__)
 346               	#  include <avr/iotn861a.h>
 347               	#elif defined (__AVR_ATtiny43U__)
 348               	#  include <avr/iotn43u.h>
 349               	#elif defined (__AVR_ATtiny48__)
 350               	#  include <avr/iotn48.h>
 351               	#elif defined (__AVR_ATtiny88__)
 352               	#  include <avr/iotn88.h>
 353               	#elif defined (__AVR_ATtiny87__)
 354               	#  include <avr/iotn87.h>
 355               	#elif defined (__AVR_ATtiny167__)
 356               	#  include <avr/iotn167.h>
 357               	#elif defined (__AVR_AT90SCR100__)
 358               	#  include <avr/io90scr100.h>
 359               	#elif defined (__AVR_ATxmega16A4__)
 360               	#  include <avr/iox16a4.h>
 361               	#elif defined (__AVR_ATxmega16D4__)
 362               	#  include <avr/iox16d4.h>
 363               	#elif defined (__AVR_ATxmega32A4__)
 364               	#  include <avr/iox32a4.h>
 365               	#elif defined (__AVR_ATxmega32D4__)
 366               	#  include <avr/iox32d4.h>
 367               	#elif defined (__AVR_ATxmega64A1__)
 368               	#  include <avr/iox64a1.h>
 369               	#elif defined (__AVR_ATxmega64A3__)
 370               	#  include <avr/iox64a3.h>
 371               	#elif defined (__AVR_ATxmega64D3__)
 372               	#  include <avr/iox64d3.h>
 373               	#elif defined (__AVR_ATxmega128A1__)
 374               	#  include <avr/iox128a1.h>
 375               	#elif defined (__AVR_ATxmega128A3__)
 376               	#  include <avr/iox128a3.h>
 377               	#elif defined (__AVR_ATxmega128D3__)
 378               	#  include <avr/iox128d3.h>
 379               	#elif defined (__AVR_ATxmega192A3__)
 380               	#  include <avr/iox192a3.h>
 381               	#elif defined (__AVR_ATxmega192D3__)
 382               	#  include <avr/iox192d3.h>
 383               	#elif defined (__AVR_ATxmega256A3__)
 384               	#  include <avr/iox256a3.h>
 385               	#elif defined (__AVR_ATxmega256A3B__)
 386               	#  include <avr/iox256a3b.h>
 387               	#elif defined (__AVR_ATxmega256D3__)
 388               	#  include <avr/iox256d3.h>
 389               	#elif defined (__AVR_ATA6289__)
 390               	#  include <avr/ioa6289.h>
 391               	/* avr1: the following only supported for assembler programs */
 392               	#elif defined (__AVR_ATtiny28__)
 393               	#  include <avr/iotn28.h>
 394               	#elif defined (__AVR_AT90S1200__)
 395               	#  include <avr/io1200.h>
 396               	#elif defined (__AVR_ATtiny15__)
 397               	#  include <avr/iotn15.h>
 398               	#elif defined (__AVR_ATtiny12__)
 399               	#  include <avr/iotn12.h>
 400               	#elif defined (__AVR_ATtiny11__)
 401               	#  include <avr/iotn11.h>
 402               	#else
 403               	#  if !defined(__COMPILING_AVR_LIBC__)
 404               	#    warning "device type not defined"
 405               	#  endif
 406               	#endif
 407               	
 408               	#include <avr/portpins.h>
   1               	/* Copyright (c) 2003  Theodore A. Roth
 409               	
 410               	#include <avr/common.h>
   1               	/* Copyright (c) 2007 Eric B. Weddington
 411               	
 412               	#include <avr/version.h>
   1               	/* Copyright (c) 2005, Joerg Wunsch                               -*- c -*-
 413               	
 414               	/* Include fuse.h after individual IO header files. */
 415               	#include <avr/fuse.h>
   1               	/* Copyright (c) 2007, Atmel Corporation
 416               	
 417               	/* Include lock.h after individual IO header files. */
 418               	#include <avr/lock.h>
   1               	/* Copyright (c) 2007, Atmel Corporation
 419               	
  13               	#include "kernel.h"
   1               	
  14               	
  15               	
  16               	
  17               	
  18               	;;===============================define vector section starting=============================;; 
  19               	;.section .vectors, "ax", @progbits                                                            
  20               	;.org    0x000C                                            ;isr location for wdt               
  21               	;        JMP   __vector_6                                                                      
  22               	;.org    0x000E                                            ;isr location for timer2compa async 
  23               	;        JMP   __vector_7                                                                      
  24               	;;=================================define vector section end================================;; 
  25               	
  26               	
  27               	
  28               	
  29               	;;============================define user address or macro starting=========================;; 
  30               	.equ     KER_TR ,         1000                            ;TickRate in Hz, not calculated      
  31               	.equ     KER_PRS,         0x03                            ;For prescaler 64, manually select   
  32               	.equ     KER_RLD,         0x82                            ;KER_RLD=0xFF-(F_CPU/KER_PRS/KER_TR) 
  33               	.equ     KER_STK_SZ,      128                             ;stack size in bytes for each task   
  34               	.equ     KER_MX_NTSK,     10                              ;max number of tasks                 
  35               	;;==============================define user address or macro end============================;; 
  36               	
  37               	
  38               	
  39               	
  40               	
  41               	;;===============================define data offsets starting===============================;; 
  42               	.equ     OFB_TICK0,       0x00                            ;offset from KerBase tick count byte0
  43               	.equ     OFB_TICK1,       0x01                            ;offset from KerBase tick count byte1
  44               	.equ     OFB_TICK2,       0x02                            ;offset from KerBase tick count byte2
  45               	.equ     OFB_TICK3,       0x03                            ;offset from KerBase tick count byte3
  46               	.equ     OFB_TICK4,       0x04                            ;offset from KerBase tick count byte4
  47               	.equ     OFB_PRS  ,       0x05                            ;offset from KerBase prescaler       
  48               	.equ     OFB_RLD  ,       0x06                            ;offset from KerBase counter reload  
  49               	.equ     OFB_TID  ,       0x07                            ;offset from KerBase task id         
  50               	.equ     OFB_NTSK ,       0x08                            ;offset from KerBase ntask           
  51               	.equ     OFB_LPR  ,       0x09                            ;offset from KerBase lowest priority 
  52               	.equ     OFB_PTID ,       0x0A                            ;offset from KerBase prio task_id    
  53               	.equ     OFB_UTC  ,       0x0B                            ;offset from KerBase usage tick cnt  
  54               	.equ     OFB_UATC ,       0x0C                            ;offset from KerBase active tick cnt 
  55               	.equ     OFB_USAGE,       0x0D                            ;offset from KerBase cpu usage       
  56               	.equ     OFB_SLCFG,       0x0E                            ;offset from KerBase sleep config    
  57               	.equ     OFM_MSPI ,       0x00                            ;offset from MSPZP msp index field   
  58               	.equ     OFM_MSPS ,       0x02                            ;offset from MSPZP msp starting      
  59               	;;==================================define data offsets end=================================;; 
  60               	
  61               	
  62               	
  63               	
  64               	
  65               	;;===============================define system macro starting===============================;; 
  66               	.equ     TASK_BLOCKED,    0x00                            ;KerSchSts val=0                     
  67               	.equ     TASK_READY,      0x01                            ;KerSchSts val=1                     
  68               	.equ     TASK_EXECUTING,  0x02                            ;KerSchSts val=2                     
  69               	.equ     TASK_SUSPENDED,  0x03                            ;KerSchSts val=3                     
  70               	.equ     TASK_CONS_LAT,   0x04                            ;KerSchSts val=3, constant latency   
  71               	.equ     SCH_MODE_HANDLER,0x00                            ;handler mode in KER_SLP_TIME_MGNT   
  72               	.equ     SCH_MODE_THREAD, 0x01                            ;thread mode in KER_SLP_TIME_MGNT    
  73               	;;==================================define system macro end=================================;; 
  74               	
  75               	
  76               	
  77               	
  78               	
  79               	;;===========================define hardware reg address starting===========================;; 
  80               	;SRAM Mapped Addresses, LDS/STS can be used                                                    
  81               	.equ     SRASSR  ,        0xB6                            ;manually defined ASSR in SRAM       
  82               	.equ     SROCR2B ,        0xB4                            ;manually defined OCR2B in SRAM      
  83               	.equ     SROCR2A ,        0xB3                            ;manually defined OCR2A in SRAM      
  84               	.equ     SRTCNT2 ,        0xB2                            ;manually defined TNCT2 in SRAM      
  85               	.equ     SRTCCR2B,        0xB1                            ;manually defined TCCR2B in SRAM     
  86               	.equ     SRTCCR2A,        0xB0                            ;manually defined TCCR2A in SRAM     
  87               	.equ     SRADMUX ,        0x7C                            ;manually defined ADMUX in SRAM      
  88               	.equ     SRADCSRA,        0x7A                            ;manually defined ADCSRA in SRAM     
  89               	.equ     SRTIMSK2,        0x70                            ;manually defined TIMSK2 in SRAM     
  90               	.equ     SRCLKPR ,        0x61                            ;manually defined CLKPR in SRAM      
  91               	.equ     SRWDTCSR,        0x60                            ;manually defined WDTCSR in SRAM     
  92               	.equ     SRSREG  ,        0x5F                            ;manually defined SREG in SRAM       
  93               	.equ     SRSPH   ,        0x5E                            ;manually defined SPH in SRAM        
  94               	.equ     SRSPL   ,        0x5D                            ;manually defined SPL in SRAM        
  95               	.equ     SRMCUCR ,        0x55                            ;manually defined MCUCR in SRAM      
  96               	.equ     SRMCUSR ,        0x54                            ;manually defined MCUSR in SRAM      
  97               	.equ     SRSMCR  ,        0x53                            ;manually defined SMCR in SRAM       
  98               	.equ     SRACSR  ,        0x50                            ;manually defined ACSR in SRAM       
  99               	.equ     SRTIFR2 ,        0x37                            ;manually defined TIFR2 in SRAM      
 100               	;IO Mapped Addresses, IN/OUT commands can be used                                              
 101               	.equ     IOSREG  ,        0x3F                            ;manually defined SREG in IO         
 102               	.equ     IOSPH   ,        0x3E                            ;manually defined SPH in IO          
 103               	.equ     IOSPL   ,        0x3D                            ;manually defined SPL in IO          
 104               	.equ     IOMCUCR ,        0x35                            ;manually defined MCUCR in IO        
 105               	.equ     IOMCUSR ,        0x34                            ;manually defined MCUSR in IO        
 106               	.equ     IOSMCR  ,        0x33                            ;manually defined SMCR in IO         
 107               	.equ     IOTIFR2 ,        0x17                            ;manually defined TIFR2 in IO        
 108               	;;==============================define hardware reg address end=============================;; 
 109               	
 110               	
 111               	
 112               	
 113               	
 114               	;;=============================define global variables starting=============================;; 
 115               	.section   .bss                                                                                
 116               	                                                                                               
 117               	.global    KerBase                                        ;declare global space for kernel     
 118 0000 0000 0000 	KerBase:   .skip 16                                       ;see offset section                  
 118      0000 0000 
 118      0000 0000 
 118      0000 0000 
 119               	                                                                                               
 120               	.global    KerPSP                                         ;space for process stack pointers    
 121 0010 0000 0000 	KerPSP:    .skip KER_MX_NTSK*2                            ;2 bytes for each task               
 121      0000 0000 
 121      0000 0000 
 121      0000 0000 
 121      0000 0000 
 122               	                                                                                               
 123               	.global    KerSSZ                                         ;stack for main stack pointers       
 124 0024 0000 0000 	KerSSZ:    .skip 14                                       ;stack_ptr(2), MSPZPn(4)             
 124      0000 0000 
 124      0000 0000 
 124      0000 
 125               	                                                                                               
 126               	.global    KerSchSts                                      ;space for scheduler status          
 127 0032 0000 0000 	KerSchSts: .skip KER_MX_NTSK*1                            ;status(1)                           
 127      0000 0000 
 127      0000 
 128               	                                                                                               
 129               	.global    KerSchPr                                       ;space for scheduler priority        
 130 003c 0000 0000 	KerSchPr:  .skip KER_MX_NTSK*1                            ;priority(1)                         
 130      0000 0000 
 130      0000 
 131               	                                                                                               
 132               	.global    KerSchSlp                                      ;space for task sleep                
 133 0046 0000 0000 	KerSchSlp: .skip KER_MX_NTSK*2                            ;timing(2)                           
 133      0000 0000 
 133      0000 0000 
 133      0000 0000 
 133      0000 0000 
 134               	                                                                                               
 135               	.global    KerStack                                       ;space for stack                     
 136 005a 0000 0000 	KerStack:  .skip KER_STK_SZ*KER_MX_NTSK                   ;KER_STK_SZ bytes for each task      
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 136      0000 0000 
 137               	;;==============================define global variables end=================================;; 
 138               	
 139               	
 140               	
 141               	
 142               	
 143               	;;===============================define text section starting===============================;; 
 144               	.section .text                                                                                 
 145               	;;==================================define text section end=================================;; 
 146               	
 147               	
 148               	
 149               	
 150               	
 151               	;;==============================define global functions starting============================;; 
 152               	.global  Kernel_Tick_Init                                                                      
 153               	.global  Kernel_Task_Create                                                                    
 154               	.global  Kernel_Start_Tasks                                                                    
 155               	.global  Kernel_Init                                                                           
 156               	.global  Kernel_Task_Idle                                                                      
 157               	.global  Kernel_Task_Sleep                                                                     
 158               	.global  Kernel_Task_Constant_Latency                                                          
 159               	.global  Kernel_Task_Constant_Latency_Sleep                                                    
 160               	.global  Kernel_PreSleep_Hook                                                                  
 161               	.global  Kernel_Clock_Prescale                                                                 
 162               	.global  Kernel_Task_Sleep_Time_Get                                                            
 163               	.global  Kernel_Task_Status_Get                                                                
 164               	.global  Kernel_NTask_Get                                                                      
 165               	.global  Kernel_Task_Prio_Get                                                                  
 166               	.global  Kernel_Lowest_Prio_Get                                                                
 167               	.global  Kernel_High_Prio_Task_ID_Get                                                          
 168               	.global  Kernel_Abs_High_Prio_Task_ID_Get                                                      
 169               	.global  Kernel_CPU_Usage_Get                                                                  
 170               	.global  Kernel_Tick_Val_Get                                                                   
 171               	.global  Kernel_Tick_Val_Safely_Get                                                            
 172               	;;================================define global functions end===============================;; 
 173               	
 174               	
 175               	
 176               	
 177               	
 178               	;;===================================wdt disable starting===================================;; 
 179               	;used registers          : R18                                                                 
 180               	;arg registers           : None                                                                
 181               	;return registers        : None                                                                
 182               	;unsafe access registers : R18                                                                 
 183               	.macro  KER_WDT_DISABLE                                   ;1.5uS @8MHz            ( 12 clocks) 
 184               	        WDR                                               ;reset wdt              (  1 clock ) 
 185               			LDS   R18                , SRMCUSR                ;copy MCUSR             (  1 clock ) 
 186               			ANDI  R18                , 0xFF & (0<<WDRF)       ;clear WDRF             (  1 clock ) 
 187               			STS   SRMCUSR            , R18                    ;set val                (  1 clock ) 
 188               			LDS   R18                , SRWDTCSR               ;copy WDTCSR            (  2 clocks) 
 189               			ORI   R18                , 0x18                   ;set WDCE,WDE           (  1 clock ) 
 190               			STS   SRWDTCSR           , R18                    ;set val                (  2 clocks) 
 191               			LDI   R18                , 0x00                   ;clear WDE              (  1 clock ) 
 192               			STS   SRWDTCSR           , R18                    ;set val                (  2 clocks) 
 193               	.endm                                                                                          
 194               	;;=====================================wdt disable endd=====================================;; 
 195               	
 196               	
 197               	
 198               	
 199               	
 200               	;;=================================timer2 disable starting==================================;; 
 201               	;used registers          : R18                                                                 
 202               	;arg registers           : None                                                                
 203               	;return registers        : None                                                                
 204               	;unsafe access registers : R18                                                                 
 205               	.macro  KER_TIMER2_DISABLE                                ;1.75uS @8MHz           ( 14 clocks) 
 206               			LDI   R18                , 0x00                   ;clear interrupt enbits (  1 clock ) 
 207               			STS   SRTIMSK2           , R18                    ;set val to TIMSK2      (  2 clocks) 
 208               			LDI   R18                , 0x00                   ;clear reg              (  1 clock ) 
 209               			STS   SRTCCR2B           , R18                    ;set val to TCCR2B      (  2 clocks) 
 210               			LDI   R18                , 0x00                   ;clear AS2 bit          (  1 clock ) 
 211               			STS   SRASSR             , R18                    ;set val to ASSR        (  2 clocks) 
 212               			LDI   R18                , 0x00                   ;set val to reg         (  1 clock ) 
 213               			STS   SROCR2B            , R18                    ;clear OCR2B            (  2 clocks) 
 214               			STS   SRTCNT2            , R18                    ;clear TCNT2            (  2 clocks) 
 215               	.endm                                                                                          
 216               	;;==================================timer2 disable end======================================;; 
 217               	
 218               	
 219               	
 220               	
 221               	
 222               	;;=====================================wdt init starting=====================================;; 
 223               	;used registers          : R18                                                                 
 224               	;arg registers           : None                                                                
 225               	;return registers        : None                                                                
 226               	;unsafe access registers : R18                                                                 
 227               	.macro  KER_WDT_INIT                                      ;1.13uS @8MHz           (  9 clocks) 
 228               	        WDR                                               ;reset wdt              (  1 clock ) 
 229               			LDS   R18                , SRWDTCSR               ;copy WDTCSR            (  2 clocks) 
 230               			ORI   R18                , 0x18                   ;set WDCE,WDE           (  1 clock ) 
 231               			STS   SRWDTCSR           , R18                    ;set val                (  2 clocks) 
 232               			#ifdef KER_WDT_TICK_16MS                                                               
 233               			LDI   R18                , 0x40                   ;WDIE                   (  1 clock ) 
 234               			#elif defined(KER_WDT_TICK_32MS)                                                       
 235               			LDI   R18                , 0x41                   ;WDIE, WDPS0            (  1 clock ) 
 236               			#elif defined(KER_WDT_TICK_64MS)                                                       
 237               			LDI   R18                , 0x42                   ;WDIE, WDPS1            (  1 clock ) 
 238               			#elif defined(KER_WDT_TICK_125MS)                                                      
 239               			LDI   R18                , 0x43                   ;WDIE, WDPS1, WDPS2     (  1 clock ) 
 240               			#elif defined(KER_WDT_TICK_250MS)                                                      
 241               			LDI   R18                , 0x44                   ;WDIE, WDPS1, WDPS2     (  1 clock ) 
 242               			#elif defined(KER_WDT_TICK_500MS)                                                      
 243               			LDI   R18                , 0x45                   ;WDIE, WDPS1, WDPS2     (  1 clock ) 
 244               			#elif defined(KER_WDT_TICK_1000MS)                                                     
 245               			LDI   R18                , 0x46                   ;WDIE, WDPS1, WDPS2     (  1 clock ) 
 246               			#else                                                                                  
 247               	        LDI   R18                , 0x40                   ;WDIE                   (  1 clock ) 
 248               			#endif                                                                                 
 249               			STS   SRWDTCSR           , R18                    ;set val                (  2 clocks) 
 250               	.endm                                                                                          
 251               	;;=====================================wdt init end=========================================;; 
 252               	
 253               	
 254               	
 255               	
 256               	
 257               	;;=================================timer2 init starting=====================================;; 
 258               	;used registers          : R18                                                                 
 259               	;arg registers           : None                                                                
 260               	;return registers        : None                                                                
 261               	;unsafe access registers : R18                                                                 
 262               	.macro  KER_TIMER2_INIT                                   ;2.50uS @8MHz           ( 20 clocks) 
 263               			LDI   R18                , 0x00                   ;clear interrupts       (  1 clock ) 
 264               			STS   SRTIMSK2           , R18                    ;set val to TIMSK2      (  2 clocks) 
 265               			LDS   R18		         , KerBase+OFB_RLD        ;load reload val        (  2 clocks) 
 266               			STS   SROCR2A            , R18                    ;set compare match val  (  2 clocks) 
 267               			LDI   R18                , 0x02                   ;set CTC mode           (  1 clock ) 
 268               	        STS   SRTCCR2A           , R18                    ;set val to TCCR2A      (  2 clocks) 
 269               			LDS   R18		         , KerBase+OFB_PRS        ;load prescaler         (  2 clocks) 
 270               			STS   SRTCCR2B           , R18                    ;set prescaler          (  2 clocks) 
 271               			LDI   R18                , 0x00                   ;clear reg              (  1 clock ) 
 272               			STS   SRTCNT2            , R18                    ;clear TCNT2            (  2 clocks) 
 273               	        LDI   R18                , 0x02                   ;set TOIE2 bit          (  1 clock ) 
 274               			STS   SRTIMSK2           , R18                    ;set val to TIMSK2      (  2 clocks) 
 275               	.endm                                                                                          
 276               	;;====================================timer2 init end=======================================;; 
 277               	
 278               	
 279               	
 280               	
 281               	
 282               	;;===============================timer2 async init starting=================================;; 
 283               	;used registers          : R18, R19                                                            
 284               	;arg registers           : None                                                                
 285               	;return registers        : None                                                                
 286               	;unsafe access registers : R18, R19                                                            
 287               	.macro  KER_TIMER2_ASYNC_INIT                             ;~9.13uS @8MHz          (~73 clocks) 
 288               			LDI   R18                , 0x00                   ;clear interrupts       (  1 clock ) 
 289               			STS   SRTIMSK2           , R18                    ;set val to TIMSK2      (  2 clocks) 
 290               			LDI   R18                , 0x20                   ;set AS2 bit            (  1 clock ) 
 291               			STS   SRASSR             , R18                    ;set val to ASSR        (  2 clocks) 
 292               			#ifdef KER_TOSC_TICK_1MS                                                               
 293               			LDI   R18                , 0x20                   ;1000Hz->clk/1/32       (  1 clock ) 
 294               			LDI   R19                , 0x01                   ;1000Hz->clk/1/32       (  1 clock ) 
 295               			#elif defined(KER_TOSC_TICK_10MS)                                                      
 296               			LDI   R18                , 0x29                   ;100Hz->clk/8/41        (  1 clock ) 
 297               			LDI   R19                , 0x02                   ;100Hz->clk/8/41        (  1 clock ) 
 298               			#elif defined(KER_TOSC_TICK_50MS)                                                      
 299               			LDI   R18                , 0xCC                   ;20Hz->clk/8/204        (  1 clock ) 
 300               			LDI   R19                , 0x02                   ;20Hz->clk/8/204        (  1 clock ) 
 301               			#elif defined(KER_TOSC_TICK_100MS)                                                     
 302               			LDI   R18                , 0x66                   ;10Hz->clk/32/102       (  1 clock ) 
 303               			LDI   R19                , 0x03                   ;10Hz->clk/32/102       (  1 clock ) 
 304               			#elif defined(KER_TOSC_TICK_250MS)                                                     
 305               			LDI   R18                , 0x80                   ;4Hz->clk/64/128        (  1 clock ) 
 306               			LDI   R19                , 0x04                   ;4Hz->clk/64/128        (  1 clock ) 
 307               			#elif defined(KER_TOSC_TICK_500MS)                                                     
 308               			LDI   R18                , 0x80                   ;2Hz->clk/128/128       (  1 clock ) 
 309               			LDI   R19                , 0x05                   ;2Hz->clk/128/128       (  1 clock ) 
 310               			#elif defined(KER_TOSC_TICK_1000MS)                                                    
 311               			LDI   R18                , 0x80                   ;1Hz->clk/256/128       (  1 clock ) 
 312               			LDI   R19                , 0x06                   ;1Hz->clk/256/128       (  1 clock ) 
 313               			#else                                                                                  
 314               			LDI   R18                , 0x20                   ;1000Hz->clk/1/32       (  1 clock ) 
 315               			LDI   R19                , 0x01                   ;1000Hz->clk/1/32       (  1 clock ) 
 316               			#endif                                                                                 
 317               			STS   SROCR2A            , R18                    ;set compare match val  (  2 clocks) 
 318               			LDI   R18                , 0x00                   ;set val to reg         (  1 clock ) 
 319               			STS   SROCR2B            , R18                    ;clear OCR2B            (  2 clocks) 
 320               			LDI   R18                , 0x02                   ;set CTC mode           (  1 clock ) 
 321               			STS   SRTCCR2A           , R18                    ;set val to TCCR2A      (  2 clocks) 
 322               			STS   SRTCCR2B           , R19                    ;set prescaler          (  2 clocks) 
 323               			LDI   R18                , 0x00                   ;clear reg              (  1 clock ) 
 324               			STS   SRTCNT2            , R18                    ;clear TCNT2            (  2 clocks) 
 325               		_KER_TC2_AUB\@:                                                                            
 326               		    LDS   R18                , SRASSR                 ;load ASSR              (  2 clocks) 
 327               	        ANDI  R18                , 0x02                   ;check bit TCR2AUB      (  1 clock ) 
 328               			BRNE  _KER_TC2_AUB\@                              ;wait until AUB cleared (  2 clocks) 
 329               		_KER_TC2_BUB\@:                                                                            
 330               		    LDS   R18                , SRASSR                 ;load ASSR              (  2 clocks) 
 331               	        ANDI  R18                , 0x01                   ;check bit TCR2BUB      (  1 clock ) 
 332               			BRNE  _KER_TC2_BUB\@                              ;wait until BUB cleared (  2 clocks) 
 333               		_KER_OC2_AUB\@:                                                                            
 334               		    LDS   R18                , SRASSR                 ;load ASSR              (  2 clocks) 
 335               	        ANDI  R18                , 0x08                   ;check bit OR2AUB       (  1 clock ) 
 336               			BRNE  _KER_OC2_AUB\@                              ;wait until AUB cleared (  2 clocks) 
 337               		_KER_OC2_BUB\@:                                                                            
 338               		    LDS   R18                , SRASSR                 ;load ASSR              (  2 clocks) 
 339               	        ANDI  R18                , 0x04                   ;check bit OCR2BUB      (  1 clock ) 
 340               			BRNE  _KER_OC2_BUB\@                              ;wait until BUB cleared (  2 clocks) 
 341               		_KER_TC2_UB\@:                                                                             
 342               		    LDS   R18                , SRASSR                 ;load ASSR              (  2 clocks) 
 343               	        ANDI  R18                , 0x10                   ;check bit TCNT2UB      (  1 clock ) 
 344               			BRNE  _KER_TC2_UB\@                               ;wait until BUB cleared (  2 clocks) 
 345               		_KER_TC2_TOV2\@:                                                                           
 346               		    LDS   R18                , SRTIFR2                ;load TIFR2             (  2 clocks) 
 347               	        ANDI  R18                , 0x01                   ;check bit TOV2         (  1 clock ) 
 348               	        BREQ  _KER_TC2_OCF2A\@                            ;bit cleared, jump next (  2 clocks) 
 349               			LDI   R18                , 0x01                   ;set bit                (  1 clock ) 
 350               			STS   SRTIFR2            , R18                    ;set val                (  2 clocks) 
 351               	    _KER_TC2_OCF2A\@:                                                                          
 352               		    LDS   R18                , SRTIFR2                ;load TIFR2             (  2 clocks) 
 353               	        ANDI  R18                , 0x02                   ;check bit OCF2A        (  1 clock ) 
 354               	        BREQ  _KER_TC2_OCF2B\@                            ;bit cleared, jump next (  2 clocks) 
 355               			LDI   R18                , 0x02                   ;set bit                (  1 clock ) 
 356               			STS   SRTIFR2            , R18                    ;set val                (  2 clocks) 
 357               		_KER_TC2_OCF2B\@:                                                                          
 358               		    LDS   R18                , SRTIFR2                ;load TIFR2             (  2 clocks) 
 359               	        ANDI  R18                , 0x04                   ;check bit OCF2B        (  1 clock ) 
 360               	        BREQ  _KER_TC2_INTEN\@                            ;bit cleared, jump next (  2 clocks) 
 361               			LDI   R18                , 0x04                   ;set bit                (  1 clock ) 
 362               			STS   SRTIFR2            , R18                    ;set val                (  2 clocks) 
 363               	    _KER_TC2_INTEN\@:                                                                          
 364               			LDI   R18                , 0x02                   ;set TOIE2 bit          (  1 clock ) 
 365               			STS   SRTIMSK2           , R18                    ;set val to TIMSK2      (  2 clocks) 
 366               	.endm                                                                                          
 367               	;;=================================timer2 async init end====================================;; 
 368               	
 369               	
 370               	
 371               	
 372               	
 373               	;;====================================timer init starting===================================;; 
 374               	;used registers          : R18, R19                                                            
 375               	;arg registers           : None                                                                
 376               	;return registers        : None                                                                
 377               	;unsafe access registers : R18, R19                                                            
 378               	.macro  KER_TIMER_INIT                                    ;~9.13uS max @8MHz      (~73 clocks) 
 379               	        #ifdef KER_WDT_AS_TICK_SRC                                                             
 380               			KER_WDT_INIT                                      ;WDT tick src           (  9 clocks) 
 381               	        #elif defined(KER_TIMER2_AS_TICK_SRC)                                                  
 382               			KER_TIMER2_INIT                                   ;TIM2COMPA tick src     ( 20 clocks) 
 383               			#elif defined(KER_TIMER2_ASYNC_AS_TICK_SRC)                                            
 384               			KER_TIMER2_ASYNC_INIT                             ;total 1.5uS @8MHz      (~73 clocks) 
 385               			#else                                                                                  
 386               	        KER_TIMER2_INIT                                   ;Default: TIM2COMPA     ( 20 clocks) 
 387               			#endif                                                                                 
 388               	.endm                                                                                          
 389               	;;======================================timer init end======================================;; 
 390               	
 391               	
 392               	
 393               	
 394               	
 395               	;;============================debug pin operation init starting=============================;; 
 396               	;used registers          : None                                                                
 397               	;arg registers           : None                                                                
 398               	;return registers        : None                                                                
 399               	;unsafe access registers : None                                                                
 400               	.macro  KER_DEBUG_PIN_INIT                                ;total 0.5uS @8MHz      (  4 clocks) 
 401               	        #ifdef KER_DBG_ENABLE                                                                  
 402               			CBI   KER_DBG_PORT       , KER_DBG_PIN            ;clear port bit         (  2 clocks) 
 403               			SBI   KER_DBG_DDR        , KER_DBG_PIN            ;set bit in DDR         (  2 clocks) 
 404               			#endif                                                                                 
 405               	.endm                                                                                          
 406               	;;==============================debug pin operation init end================================;; 
 407               	
 408               	
 409               	
 410               	
 411               	
 412               	;;===========================debug pin operation set starting===============================;; 
 413               	;used registers          : None                                                                
 414               	;arg registers           : None                                                                
 415               	;return registers        : None                                                                
 416               	;unsafe access registers : None                                                                
 417               	.macro  KER_DEBUG_PIN_SET                                 ;total 0.25uS @8MHz     (  2 clocks) 
 418               	        #ifdef KER_DBG_ENABLE                                                                  
 419               	        SBI   KER_DBG_PORT       , KER_DBG_PIN            ;set gpio               (  2 clocks) 
 420               			#endif                                                                                 
 421               	.endm                                                                                          
 422               	;;==============================debug pin operation set end=================================;; 
 423               	
 424               	
 425               	
 426               	
 427               	
 428               	;;===========================debug pin operation clear starting=============================;; 
 429               	;used registers          : None                                                                
 430               	;arg registers           : None                                                                
 431               	;return registers        : None                                                                
 432               	;unsafe access registers : None                                                                
 433               	.macro  KER_DEBUG_PIN_CLEAR                               ;total 0.25uS @8MHz     (  2 clocks) 
 434               	        #ifdef KER_DBG_ENABLE                                                                  
 435               			CBI   KER_DBG_PORT       , KER_DBG_PIN            ;clear gpio             (  2 clocks) 
 436               			#endif                                                                                 
 437               	.endm                                                                                          
 438               	;;==============================debug pin operation clear end===============================;; 
 439               	
 440               	
 441               	
 442               	
 443               	
 444               	;;=================================save r0 & sreg starting==================================;; 
 445               	;used registers          : R0                                                                  
 446               	;arg registers           : None                                                                
 447               	;return registers        : None                                                                
 448               	;unsafe access registers : None                                                                
 449               	.macro  KER_SAVE_R0_SREG                                  ;total 0.63uS @8MHz     (  5 clocks) 
 450               	        PUSH  R0                                          ;save R0                (  2 clocks) 
 451               			IN    R0                 , IOSREG                 ;load SREG              (  1 clock ) 
 452               			PUSH  R0                                          ;save SREG              (  2 clocks) 
 453               	.endm                                                                                          
 454               	;;====================================save r0 & sreg end====================================;; 
 455               	
 456               	
 457               	
 458               	
 459               	
 460               	;;===============================save r0, sreg & cli starting===============================;; 
 461               	;used registers          : R0                                                                  
 462               	;arg registers           : None                                                                
 463               	;return registers        : None                                                                
 464               	;unsafe access registers : None                                                                
 465               	.macro  KER_SAVE_R0_CLI_SREG                              ;total 0.75uS @8MHz     (  6 clocks) 
 466               	        PUSH  R0                                          ;push R0                (  2 clocks) 
 467               			IN    R0                 , IOSREG                 ;save SREG              (  1 clock ) 
 468               			CLI                                               ;clear interrupt        (  1 clock ) 
 469               			PUSH  R0                                          ;save SREG              (  2 clocks) 
 470               	.endm                                                                                          
 471               	;;=================================save r0, sreg & cli end==================================;; 
 472               	
 473               	
 474               	
 475               	
 476               	
 477               	;;===================================save r1~r31 starting===================================;; 
 478               	;used registers          : R1~R31                                                              
 479               	;arg registers           : None                                                                
 480               	;return registers        : None                                                                
 481               	;unsafe access registers : None                                                                
 482               	.macro  KER_SAVE_R1_R31                                   ;total 7.88uS @8MHz     ( 63 clocks) 
 483               			PUSH  R1                                          ;save R1                (  2 clocks) 
 484               			CLR   R1                                          ;clear R1               (  1 clock ) 
 485               			PUSH  R2                                          ;save R2                (  2 clocks) 
 486               			PUSH  R3                                          ;save R3                (  2 clocks) 
 487               			PUSH  R4                                          ;save R4                (  2 clocks) 
 488               			PUSH  R5                                          ;save R5                (  2 clocks) 
 489               			PUSH  R6                                          ;save R6                (  2 clocks) 
 490               			PUSH  R7                                          ;save R7                (  2 clocks) 
 491               			PUSH  R8                                          ;save R8                (  2 clocks) 
 492               			PUSH  R9                                          ;save R9                (  2 clocks) 
 493               			PUSH  R10                                         ;save R10               (  2 clocks) 
 494               			PUSH  R11                                         ;save R11               (  2 clocks) 
 495               			PUSH  R12                                         ;save R12               (  2 clocks) 
 496               			PUSH  R13                                         ;save R13               (  2 clocks) 
 497               			PUSH  R14                                         ;save R14               (  2 clocks) 
 498               			PUSH  R15                                         ;save R15               (  2 clocks) 
 499               			PUSH  R16                                         ;save R16               (  2 clocks) 
 500               			PUSH  R17                                         ;save R17               (  2 clocks) 
 501               			PUSH  R18                                         ;save R18               (  2 clocks) 
 502               			PUSH  R19                                         ;save R19               (  2 clocks) 
 503               			PUSH  R20                                         ;save R20               (  2 clocks) 
 504               			PUSH  R21                                         ;save R21               (  2 clocks) 
 505               			PUSH  R22                                         ;save R22               (  2 clocks) 
 506               			PUSH  R23                                         ;save R23               (  2 clocks) 
 507               			PUSH  R24                                         ;save R24               (  2 clocks) 
 508               			PUSH  R25                                         ;save R25               (  2 clocks) 
 509               			PUSH  R26                                         ;save R26               (  2 clocks) 
 510               			PUSH  R27                                         ;save R27               (  2 clocks) 
 511               			PUSH  R28                                         ;save R28               (  2 clocks) 
 512               			PUSH  R29                                         ;save R29               (  2 clocks) 
 513               			PUSH  R30                                         ;save R30               (  2 clocks) 
 514               			PUSH  R31                                         ;save R31               (  2 clocks) 
 515               	.endm                                                                                          
 516               	;;======================================save r1~r31 end=====================================;; 
 517               	
 518               	
 519               	
 520               	
 521               	
 522               	;;==============================context save handler starting===============================;; 
 523               	;used registers          : R0~R31                                                              
 524               	;arg registers           : None                                                                
 525               	;return registers        : None                                                                
 526               	;unsafe access registers : None                                                                
 527               	.macro  KER_CONTEXT_SAVE_HANDLER                          ;total 8.5uS @8MHz      ( 68 clocks) 
 528               	        KER_SAVE_R0_SREG                                  ;save r0, sreg          (  5 clocks) 
 529               	        KER_SAVE_R1_R31                                   ;save r1~r31            ( 63 clocks) 
 530               	.endm                                                                                          
 531               	;;=================================context save handler end=================================;; 
 532               	
 533               	
 534               	
 535               	
 536               	
 537               	;;===============================context save thread starting===============================;; 
 538               	;used registers          : R0~R31                                                              
 539               	;arg registers           : None                                                                
 540               	;return registers        : None                                                                
 541               	;unsafe access registers : None                                                                
 542               	.macro  KER_CONTEXT_SAVE_THREAD                           ;total 8.63uS @8MHz     ( 69 clocks) 
 543               	        KER_SAVE_R0_CLI_SREG                              ;save r0, sreg          (  6 clocks) 
 544               	        KER_SAVE_R1_R31                                   ;save r1~r31            ( 63 clocks) 
 545               	.endm                                                                                          
 546               	;;==================================context save thread end=================================;; 
 547               	
 548               	
 549               	
 550               	
 551               	
 552               	
 553               	;;================================restore r0 & sreg starting================================;; 
 554               	;used registers          : R0                                                                  
 555               	;arg registers           : None                                                                
 556               	;return registers        : None                                                                
 557               	;unsafe access registers : None                                                                
 558               	.macro  KER_RESTORE_R0_SREG                               ;total 0.63uS @8MHz     (  5 clocks) 
 559               	        POP   R0                                          ;fetch SREG             (  2 clocks) 
 560               			OUT   IOSREG             , R0                     ;load SREG              (  1 clock ) 
 561               			POP   R0                                          ;restore R0             (  2 clocks) 
 562               	.endm                                                                                          
 563               	;;==================================restore r0 & sreg end===================================;; 
 564               	
 565               	
 566               	
 567               	
 568               	
 569               	;;==============================restore r0, sreg & sei starting=============================;; 
 570               	;used registers          : R0                                                                  
 571               	;arg registers           : None                                                                
 572               	;return registers        : None                                                                
 573               	;unsafe access registers : None                                                                
 574               	.macro  KER_RESTORE_R0_SREG_SEI                           ;total 0.75uS @8MHz     (  6 clocks) 
 575               	        POP   R0                                          ;fetch SREG             (  2 clocks) 
 576               			OUT   IOSREG             , R0                     ;load SREG              (  1 clock ) 
 577               			POP   R0                                          ;restore R0             (  2 clocks) 
 578               			SEI                                               ;enable interrupt       (  1 clock ) 
 579               	.endm                                                                                          
 580               	;;===============================restore r0, sreg & sei end=================================;; 
 581               	
 582               	
 583               	
 584               	
 585               	
 586               	;;=================================restore r1~r31 starting==================================;; 
 587               	;used registers          : R1~R31                                                              
 588               	;arg registers           : None                                                                
 589               	;return registers        : None                                                                
 590               	;unsafe access registers : None                                                                
 591               	.macro  KER_RESTORE_R1_R31                                ;total 8.38uS @8MHz     ( 62 clocks) 
 592               			POP   R31                                         ;restore R31            (  2 clocks) 
 593               			POP   R30                                         ;restore R30            (  2 clocks) 
 594               			POP   R29                                         ;restore R29            (  2 clocks) 
 595               			POP   R28                                         ;restore R28            (  2 clocks) 
 596               			POP   R27                                         ;restore R27            (  2 clocks) 
 597               			POP   R26                                         ;restore R26            (  2 clocks) 
 598               			POP   R25                                         ;restore R25            (  2 clocks) 
 599               			POP   R24                                         ;restore R24            (  2 clocks) 
 600               			POP   R23                                         ;restore R23            (  2 clocks) 
 601               			POP   R22                                         ;restore R22            (  2 clocks) 
 602               			POP   R21                                         ;restore R21            (  2 clocks) 
 603               			POP   R20                                         ;restore R20            (  2 clocks) 
 604               			POP   R19                                         ;restore R19            (  2 clocks) 
 605               			POP   R18                                         ;restore R18            (  2 clocks) 
 606               			POP   R17                                         ;restore R17            (  2 clocks) 
 607               			POP   R16                                         ;restore R16            (  2 clocks) 
 608               			POP   R15                                         ;restore R15            (  2 clocks) 
 609               			POP   R14                                         ;restore R14            (  2 clocks) 
 610               			POP   R13                                         ;restore R13            (  2 clocks) 
 611               			POP   R12                                         ;restore R12            (  2 clocks) 
 612               			POP   R11                                         ;restore R11            (  2 clocks) 
 613               			POP   R10                                         ;restore R10            (  2 clocks) 
 614               			POP   R9                                          ;restore R9             (  2 clocks) 
 615               			POP   R8                                          ;restore R8             (  2 clocks) 
 616               			POP   R7                                          ;restore R7             (  2 clocks) 
 617               			POP   R6                                          ;restore R6             (  2 clocks) 
 618               			POP   R5                                          ;restore R5             (  2 clocks) 
 619               			POP   R4                                          ;restore R4             (  2 clocks) 
 620               			POP   R3                                          ;restore R3             (  2 clocks) 
 621               			POP   R2                                          ;restore R2             (  2 clocks) 
 622               			POP   R1                                          ;restore R1             (  2 clocks) 
 623               	.endm                                                                                          
 624               	;;====================================restore r1~r31 end====================================;; 
 625               	
 626               	
 627               	
 628               	
 629               	
 630               	;;=============================context restore handler starting=============================;; 
 631               	;used registers          : R0~R31                                                              
 632               	;arg registers           : None                                                                
 633               	;return registers        : None                                                                
 634               	;unsafe access registers : None                                                                
 635               	.macro  KER_CONTEXT_RESTORE_HANDLER                       ;total 8.38uS @8MHz     ( 67 clocks) 
 636               	        KER_RESTORE_R1_R31                                ;restore r1~r31         ( 62 clocks) 
 637               			KER_RESTORE_R0_SREG                               ;restore r0, sreg       (  5 clocks) 
 638               	.endm                                                                                          
 639               	;;===============================context restore handler end================================;; 
 640               	
 641               	
 642               	
 643               	
 644               	
 645               	;;=============================context restore thread starting==============================;; 
 646               	;used registers          : R0~R31                                                              
 647               	;arg registers           : None                                                                
 648               	;return registers        : None                                                                
 649               	;unsafe access registers : None                                                                
 650               	.macro  KER_CONTEXT_RESTORE_THREAD                        ;total 8.75uS @8MHz     ( 68 clocks) 
 651               	        KER_RESTORE_R1_R31                                ;restore r1~r31         ( 62 clocks) 
 652               			KER_RESTORE_R0_SREG_SEI                           ;restore r0, sreg       (  6 clocks) 
 653               	.endm                                                                                          
 654               	;;================================context restore thread end================================;; 
 655               	
 656               	
 657               	
 658               	
 659               	
 660               	;;=========================calculate offset addr in words starting==========================;; 
 661               	;used registers          : R18, R30(ZL), R31(ZH)                                               
 662               	;arg registers           : R30(ZL), R31(ZH)                                                    
 663               	;return registers        : R30(ZL), R31(ZH)                                                    
 664               	;unsafe access registers : R18, R30(ZL), R31(ZH)                                               
 665               	.macro  KER_CALC_ADDR_OFF_WORD                            ;total 0.75uS @8MHz     (  6 clocks) 
 666               	        LDS   R18                , KerBase+OFB_TID        ;fetch task_id          (  2 clocks) 
 667               			LSL   R18                                         ;left shift to multiply (  1 clock ) 
 668               			ADD   R30                , R18                    ;add offset to array    (  1 clock ) 
 669               			LDI   R18                , 0x00                   ;clear for carry prop   (  1 clock ) 
 670               			ADC   R31                , R18                    ;add carry if any       (  1 clock ) 
 671               	.endm                                                                                          
 672               	;;=============================calculate offset addr in words end===========================;; 
 673               	
 674               	
 675               	
 676               	
 677               	
 678               	;;=========================calculate offset addr in bytes starting==========================;; 
 679               	;used registers          : R18, R30(ZL), R31(ZH)                                               
 680               	;arg registers           : R30(ZL), R31(ZH)                                                    
 681               	;return registers        : R30(ZL), R31(ZH)                                                    
 682               	;unsafe access registers : R18, R30(ZL), R31(ZH)                                               
 683               	.macro  KER_CALC_ADDR_OFF_BYTES                           ;total 0.63uS @8MHz     (  5 clocks) 
 684               	        LDS   R18                , KerBase+OFB_TID        ;fetch task_id          (  2 clocks) 
 685               			ADD   R30                , R18                    ;add offset to array    (  1 clock ) 
 686               			LDI   R18                , 0x00                   ;clear for carry prop   (  1 clock ) 
 687               			ADC   R31                , R18                    ;add carry if any       (  1 clock ) 
 688               	.endm                                                                                          
 689               	;;=============================calculate offset addr in bytes end===========================;; 
 690               	
 691               	
 692               	
 693               	
 694               	
 695               	;;===============================save current task sp starting==============================;; 
 696               	;used registers          : R18, R19, R30(ZL), R31(ZH)                                          
 697               	;arg registers           : None                                                                
 698               	;return registers        : None                                                                
 699               	;unsafe access registers : R18, R19, R30(ZL), R31(ZH)                                          
 700               	.macro  KER_SAVE_CURR_TASK_SP                             ;total 1.75uS @8MHz     ( 14 clocks) 
 701               			LDI   R30                , lo8(KerPSP)            ;fetch base pos low     (  1 clock ) 
 702               			LDI   R31                , hi8(KerPSP)            ;fetch base pos high    (  1 clock ) 
 703               			KER_CALC_ADDR_OFF_WORD                            ;calc offset            (  6 clocks) 
 704               			IN    R18                , IOSPL                  ;fetch SPL0             (  1 clock ) 
 705               			IN    R19                , IOSPH                  ;fetch SPH0             (  1 clock ) 
 706               			STD   Z+0                , R18                    ;store SPL at ZP+0      (  2 clocks) 
 707               			STD   Z+1                , R19                    ;store SPH at ZP+1      (  2 clocks) 
 708               	.endm                                                                                          
 709               	;;================================save current task sp end==================================;; 
 710               	
 711               	
 712               	
 713               	
 714               	
 715               	;;==============================increment tick counter starting=============================;; 
 716               	;used registers          : R18, R19                                                            
 717               	;arg registers           : None                                                                
 718               	;return registers        : None                                                                
 719               	;unsafe access registers : R18, R19                                                            
 720               	.macro  KER_TICK_INCREMENT                                ;total 3.25uS @8MHz     ( 27 clocks) 
 721               	        LDI   R18                , 0x01                   ;load 1                 (  1 clock ) 
 722               			LDS   R19                , KerBase+OFB_TICK0      ;load Byte0             (  2 clocks) 
 723               			ADD   R19                , R18                    ;add 1 with current val (  1 clock ) 
 724               			STS   KerBase+OFB_TICK0  , R19                    ;set Byte0              (  2 clocks) 
 725               			LDI   R18                , 0x00                   ;clear reg              (  1 clock ) 
 726               			LDS   R19                , KerBase+OFB_TICK1      ;load Byte1             (  2 clocks) 
 727               			ADC   R19                , R18                    ;add carry with Byte1   (  1 clock ) 
 728               			STS   KerBase+OFB_TICK1  , R19                    ;set Byte1              (  2 clocks) 
 729               			LDS   R19                , KerBase+OFB_TICK2      ;load Byte2             (  2 clocks) 
 730               			ADC   R19                , R18                    ;add carry with Byte2   (  1 clock ) 
 731               			STS   KerBase+OFB_TICK2  , R19                    ;set Byte2              (  2 clocks) 
 732               			LDS   R19                , KerBase+OFB_TICK3      ;load Byte3             (  2 clocks) 
 733               			ADC   R19                , R18                    ;add carry with Byte3   (  1 clock ) 
 734               			STS   KerBase+OFB_TICK3  , R19                    ;set Byte3              (  2 clocks) 
 735               			LDS   R19                , KerBase+OFB_TICK4      ;load Byte4             (  2 clocks) 
 736               			ADC   R19                , R18                    ;add carry with Byte4   (  1 clock ) 
 737               			STS   KerBase+OFB_TICK4  , R19                    ;set Byte4              (  2 clocks) 
 738               	.endm                                                                                          
 739               	;;=================================increment tick counter end===============================;; 
 740               	
 741               	
 742               	
 743               	
 744               	
 745               	;;==============================load task id & sp starting==================================;; 
 746               	;used registers          : R18, R19, R30(ZL), R31(ZH)                                          
 747               	;arg registers           : None                                                                
 748               	;return registers        : None                                                                
 749               	;unsafe access registers : R18, R19, R30(ZL), R31(ZH)                                          
 750               	.macro  KER_LOAD_TASK_ID_AND_SP                           ;total 1.75uS @8MHz     ( 14 clocks) 
 751               			LDI   R30                , lo8(KerPSP)            ;fetch base pos low     (  1 clock ) 
 752               			LDI   R31                , hi8(KerPSP)            ;fetch base pos high    (  1 clock ) 
 753               			KER_CALC_ADDR_OFF_WORD                            ;calc offset            (  6 clocks) 
 754               			LDD   R18                , Z+0                    ;load SPL at ZP         (  2 clocks) 
 755               			LDD   R19                , Z+1                    ;load SPH at ZP         (  2 clocks) 
 756               			OUT   IOSPL              , R18                    ;load SPL0              (  1 clock ) 
 757               			OUT   IOSPH              , R19                    ;load SPH0              (  1 clock ) 
 758               	.endm                                                                                          
 759               	;;=================================load task id & sp end====================================;; 
 760               	
 761               	
 762               	
 763               	
 764               	
 765               	;;================================push msp & zp starting====================================;; 
 766               	;used registers          : R18, R19, R26(XL), R27(XH), R30(ZL), R31(ZH)                        
 767               	;arg registers           : None                                                                
 768               	;return registers        : None                                                                
 769               	;unsafe access registers : R18, R19, R26(XL), R27(XH), R30(ZL), R31(ZH)                        
 770               	.macro  KER_PUSH_MSP_ZP                                   ;total 2.25uS @8MHz     ( 18 clocks) 
 771               	        LDS   R26                , KerSSZ+OFM_MSPI+0      ;load val low           (  2 clocks) 
 772               			LDS   R27                , KerSSZ+OFM_MSPI+1      ;load val high          (  2 clocks) 
 773               			IN    R18                , IOSPL                  ;copy                   (  1 clock ) 
 774               			IN    R19                , IOSPH                  ;copy                   (  1 clock ) 
 775               			ST    X+                 , R18                    ;store main SPL         (  2 clocks) 
 776               	        ST    X+                 , R19                    ;store main SPH         (  2 clocks) 
 777               			ST    X+                 , R30                    ;store main ZL          (  2 clocks) 
 778               			ST    X+                 , R31                    ;store main ZH          (  2 clocks) 
 779               			STS   KerSSZ+OFM_MSPI+0  , R26                    ;store new index        (  2 clocks) 
 780               			STS   KerSSZ+OFM_MSPI+1  , R27                    ;store new index        (  2 clocks) 
 781               	.endm                                                                                          
 782               	;;===================================push msp & zp end======================================;; 
 783               	
 784               	
 785               	
 786               	
 787               	
 788               	;;=================================pop msp & zp starting====================================;; 
 789               	;used registers          : R18, R19, R26(XL), R27(XH), R30(ZL), R31(ZH)                        
 790               	;arg registers           : None                                                                
 791               	;return registers        : None                                                                
 792               	;unsafe access registers : R18, R19, R26(XL), R27(XH), R30(ZL), R31(ZH)                        
 793               	.macro  KER_POP_MSP_ZP                                    ;total 2.25uS @8MHz     ( 18 clocks) 
 794               			LDS   R26                , KerSSZ+OFM_MSPI+0      ;load val low           (  2 clocks) 
 795               			LDS   R27                , KerSSZ+OFM_MSPI+1      ;load val high          (  2 clocks) 
 796               			LD    R31                , -X                     ;load ZH                (  2 clocks) 
 797               			LD    R30                , -X                     ;load ZL                (  2 clocks) 
 798               			LD    R19                , -X                     ;load main SPH          (  2 clocks) 
 799               			LD    R18                , -X                     ;load main SPL          (  2 clocks) 
 800               			OUT   IOSPL              , R18                    ;set SPL                (  1 clock ) 
 801               			OUT   IOSPH              , R19                    ;set SPH                (  1 clock ) 
 802               			STS   KerSSZ+OFM_MSPI+0  , R26                    ;store new index        (  2 clocks) 
 803               			STS   KerSSZ+OFM_MSPI+1  , R27                    ;store new index        (  2 clocks) 
 804               	.endm                                                                                          
 805               	;;====================================pop msp & zp end======================================;; 
 806               	
 807               	
 808               	
 809               	
 810               	
 811               	;;============================sleep timeout management starting=============================;; 
 812               	;used registers          : R18, R19, R20, R24, R30(ZL), R31(ZH)                                
 813               	;arg registers           : R24 (SCH_MODE_HANDLER/SCH_MODE_THREAD)                              
 814               	;return registers        : R24 (READY/BLOCKED/EXECUTING/SUSPENDED/CONS_LAT)                    
 815               	;unsafe access registers : R18, R19, R20, R24, R30(ZL), R31(ZH)                                
 816               	.macro  KER_SLP_TIME_MGNT                                 ;total 6.50uS @8MHz     ( 52 clocks) 
 817               			LDI   R30                , lo8(KerSchSlp)         ;fetch base pos low     (  1 clock ) 
 818               			LDI   R31                , hi8(KerSchSlp)         ;fetch base pos high    (  1 clock ) 
 819               			KER_CALC_ADDR_OFF_WORD                            ;calc offset            (  6 clocks) 
 820               			;fetch current value from ram, if val=0, skip decrement                                
 821               	        LDD   R18                , Z+0                    ;load val low byte      (  2 clocks) 
 822               			LDD   R19                , Z+1                    ;load val high byte     (  2 clocks) 
 823               			MOV   R20                , R18                    ;copy                   (  1 clock ) 
 824               			OR    R20                , R19                    ;or high & low bytes    (  1 clock ) 
 825               			BREQ  _VAL_NULL\@                                 ;val=0, save sts        (  2 clocks) 
 826               	        CPI   R24                , SCH_MODE_THREAD        ;if arg=1, thread mode  (  1 clock ) 
 827               			BREQ  _VAL_NOT_NULL\@                             ;no need to dec val     (  2 clocks) 
 828               			;R19:R18 contains 16 bit sleep timer val, decrease val by 1                            
 829               			LDI   R20                , 0x01                   ;set val 1              (  1 clock ) 
 830               	        SUB   R18                , R20                    ;subtract low byte      (  1 clock ) 
 831               			LDI   R20                , 0x00                   ;clear                  (  1 clock ) 
 832               			SBC   R19                , R20                    ;subtract carry if any  (  1 clock ) 
 833               			;store new value                                                                       
 834               			STD   Z+0                , R18                    ;store low byte         (  2 clocks) 
 835               			STD   Z+1                , R19                    ;store low byte         (  2 clocks) 
 836               			MOV   R20                , R18                    ;copy                   (  1 clock ) 
 837               			OR    R20                , R19                    ;or high & low bytes    (  1 clock ) 
 838               			BRNE  _VAL_NOT_NULL\@                             ;val!=0                 (  2 clocks) 
 839               		_VAL_NULL\@:                                                                               
 840               		    ;find ram address for status                                                           
 841               		    LDI   R30                , lo8(KerSchSts)         ;fetch base pos low     (  1 clock ) 
 842               			LDI   R31                , hi8(KerSchSts)         ;fetch base pos high    (  1 clock ) 
 843               	        KER_CALC_ADDR_OFF_BYTES                           ;calc offset            (  5 clocks) 
 844               			;update flag as task is ready                                                          
 845               			LDI   R24                , TASK_READY             ;set TASK_READY         (  1 clock ) 
 846               			ST    Z                  , R24                    ;update flag            (  2 clocks) 
 847               			RJMP  _EXIT_SLP_TIME\@                            ;jump to exit           (  2 clocks) 
 848               	    _VAL_NOT_NULL\@:                                                                           
 849               		    LDI   R30                , lo8(KerSchSts)         ;fetch base pos low     (  1 clock ) 
 850               			LDI   R31                , hi8(KerSchSts)         ;fetch base pos high    (  1 clock ) 
 851               	        KER_CALC_ADDR_OFF_BYTES                           ;calc offset            (  5 clocks) 
 852               		    LD    R24                , Z                      ;return sts             (  2 clocks) 
 853               	    _EXIT_SLP_TIME\@:                                                                          
 854               	.endm                                                                                          
 855               	;;============================sleep timeout management end==================================;; 
 856               	
 857               	
 858               	
 859               	
 860               	
 861               	;;============================current task priority starting================================;; 
 862               	;used registers          : R18, R24, R30(ZL), R31(ZH)                                          
 863               	;arg registers           : None                                                                
 864               	;return registers        : R24 (Current task priority)                                         
 865               	;unsafe access registers : R18, R24, R30(ZL), R31(ZH)                                          
 866               	.macro  KER_CURR_TASK_PRIO                                ;total 1.13uS @8MHz     (  9 clocks) 
 867               			LDI    R30               , lo8(KerSchPr)          ;load low addr          (  1 clock ) 
 868               			LDI    R31               , hi8(KerSchPr)          ;load high addr         (  1 clock ) 
 869               			LDI    R18               , 0x00                   ;clear reg, for carry   (  1 clock ) 
 870               			LDS    R24               , KerBase+OFB_TID        ;load task id           (  2 clocks) 
 871               	        ADD    R30               , R24                    ;add low addr           (  1 clock ) 
 872               			ADC    R31               , R18                    ;add carry if any       (  1 clock ) 
 873               			LD     R24               , Z                      ;load current tid prio  (  2 clocks) 
 874               	.endm                                                                                          
 875               	;;==============================current task priority end===================================;; 
 876               	
 877               	
 878               	
 879               	
 880               	
 881               	;;================================run scheduler starting====================================;; 
 882               	;used registers          : R18, R19, R20, R21, R24, R25, R30(ZL), R31(ZH)                      
 883               	;arg registers           : R24 (SCH_MODE_HANDLER/SCH_MODE_THREAD)                              
 884               	;return registers        : None                                                                
 885               	;unsafe access registers : R18, R19, R20, R21, R24, R25, R30(ZL), R31(ZH)                      
 886               	.macro  KER_RUN_SCHEDULER                                 ;total 13.25uS @8MHz    (106 clocks) 
 887               			LDI    R18               , 0xFF                   ;set 0xff               (  1 clock ) 
 888               			STS    KerBase+OFB_LPR   , R18                    ;lowest priority        (  2 clocks) 
 889               			LDI    R18               , 0x00                   ;start from 0           (  1 clock ) 
 890               			STS    KerBase+OFB_PTID  , R18                    ;highest prio tid=0     (  2 clocks) 
 891               			MOV    R21               , R24                    ;copy sch mode          (  1 clock ) 
 892               		_KER_SCH_LOOP\@:                                                                           
 893               		    ;store task id to run from KER_DEC_SLP_TIMEOUT                                         
 894               			STS    KerBase+OFB_TID   , R18                    ;store task id          (  2 clocks) 
 895               	        ;sleep time decrement, update ready/blocked status                                     
 896               			MOV    R24               , R21                    ;restore sch mode       (  1 clock ) 
 897               			KER_SLP_TIME_MGNT                                 ;update return vars     ( 52 clocks) 
 898               	        CPI    R24               , TASK_READY             ;compare                (  1 clock ) 
 899               	        BREQ   _KER_CALC_PRIO\@                           ;calc priority if ready (  2 clocks) 
 900               			CPI    R24               , TASK_CONS_LAT          ;compare                (  1 clock ) 
 901               	        BREQ   _KER_CALC_PRIO\@                           ;calc priority if c_lat (  2 clocks) 
 902               	        RJMP   _KER_SCH_NEXT\@                            ;skip if !ready|c_lat   (  2 clocks) 
 903               		_KER_CALC_PRIO\@:                                                                          
 904               			KER_CURR_TASK_PRIO                                ;get task prio ->R24    (  9 clocks) 
 905               	        ;compare current task priority with lowest priority found so far                       
 906               			LDS    R18               , KerBase+OFB_LPR        ;load lowest priority   (  2 clocks) 
 907               			CP     R24               , R18                    ;compare                (  1 clock ) 
 908               			BRSH   _KER_SCH_NEXT\@                            ;if prio>=lowest prio   (  2 clocks) 
 909               			;found new lowest priority                                                             
 910               			STS    KerBase+OFB_LPR   , R24                    ;save lowest priority   (  2 clocks) 
 911               			LDS    R18               , KerBase+OFB_TID        ;load task id           (  2 clocks) 
 912               			STS    KerBase+OFB_PTID  , R18                    ;save lowest priority   (  2 clocks) 
 913               	                                                                                               
 914               	    _KER_SCH_NEXT\@:                                                                           
 915               		    LDS    R18               , KerBase+OFB_TID        ;load task id           (  2 clocks) 
 916               			INC    R18                                        ;increment by 1         (  1 clock ) 
 917               			LDS    R19               , KerBase+OFB_NTSK       ;load ntask             (  2 clocks) 
 918               			CP     R18               , R19                    ;compare with ntask     (  2 clocks) 
 919               			BRSH   _KER_SCH_EXIT\@                            ;if task_id>=ntask      (  2 clocks) 
 920               			RJMP   _KER_SCH_LOOP\@                            ;jump to entry          (  2 clocks) 
 921               		_KER_SCH_EXIT\@:                                                                           
 922               	        LDS    R18               , KerBase+OFB_PTID       ;load high prio task id (  2 clocks) 
 923               			STS    KerBase+OFB_TID   , R18                    ;for test only          (  2 clocks) 
 924               	.endm                                                                                          
 925               	;;===================================run scheduler end======================================;; 
 926               	
 927               	
 928               	
 929               	
 930               	
 931               	;;================================calc cpu usage starting===================================;; 
 932               	;used registers          : R18, R19                                                            
 933               	;arg registers           : None                                                                
 934               	;return registers        : None                                                                
 935               	;unsafe access registers : R18, R19                                                            
 936               	.macro  KER_CPU_USAGE                                     ;total 3.25uS @8MHz     ( 26 clocks) 
 937               	        ;check if current target task is idle task or not                                      
 938               	        LDS    R18               , KerBase+OFB_TID        ;load target task_id    (  2 clocks) 
 939               			TST    R18                                        ;check if idle task     (  1 clock ) 
 940               			BREQ   _KER_USG_TICK\@                            ;task_id=idle, skip     (  2 clocks) 
 941               			LDS    R18               , KerBase+OFB_UATC       ;load active tick cnt   (  2 clocks) 
 942               			INC    R18                                        ;inc active tick cnt    (  1 clock ) 
 943               			STS    KerBase+OFB_UATC  , R18                    ;store new val          (  2 clocks) 
 944               		_KER_USG_TICK\@:                                                                           
 945               			LDS    R18               , KerBase+OFB_UTC        ;load usage tick cnt    (  2 clocks) 
 946               			INC    R18                                        ;increment tick cnt     (  1 clock ) 
 947               			CPI    R18               , 100                    ;compare with 100       (  1 clock ) 
 948               			BRLO   _KER_USG_UTC_SV\@                          ;val<100, save new val  (  2 clocks) 
 949               			LDI    R18               , 0x00                   ;val>=100, roll back    (  1 clock ) 
 950               			LDS    R19               , KerBase+OFB_UATC       ;load active tick cnt   (  2 clocks) 
 951               			STS    KerBase+OFB_USAGE , R19                    ;store usage            (  2 clocks) 
 952               			LDI    R19               , 0x00                   ;clear reg              (  1 clock ) 
 953               			STS    KerBase+OFB_UATC  , R19                    ;clear active tick cnt  (  2 clocks) 
 954               		_KER_USG_UTC_SV\@:                                                                         
 955               			STS    KerBase+OFB_UTC   , R18                    ;store new val          (  2 clocks) 
 956               	.endm                                                                                          
 957               	;;===================================calc cpu usage end=====================================;; 
 958               	
 959               	
 960               	
 961               	
 962               	
 963               	;;===========================kernel disable analog domain starting==========================;; 
 964               	;used registers          : None                                                                
 965               	;arg registers           : None                                                                
 966               	;return registers        : None                                                                
 967               	;unsafe access registers : None                                                                
 968               	.macro KER_DISABLE_ANALOG_DOMAIN                          ;total 0.75uS @8MHz     ( 10 clocks) 
 969               	    #ifdef KER_IDLE_AS_SLEEP                                                                   
 970               			LDS   R18                , SRADCSRA               ;load ADCSRA            (  2 clocks) 
 971               			ANDI  R18                , 0x7F                   ;clear ADEN             (  1 clock ) 
 972               			STS   SRADCSRA           , R18                    ;set val                (  2 clocks) 
 973               			LDS   R18                , SRACSR                 ;load ACSR              (  2 clocks) 
 974               			ORI   R18                , 0x80                   ;set ACD                (  1 clock ) 
 975               			STS   SRACSR             , R18                    ;set val                (  2 clocks) 
 976               		#endif                                                                                     
 977               	.endm                                                                                          
 978               	;;=============================kernel disable analog domain end=============================;; 
 979               	
 980               	
 981               	
 982               	
 983               	
 984               	;;===============================kernel sleep config starting===============================;; 
 985               	;used registers          : R18                                                                 
 986               	;arg registers           : None                                                                
 987               	;return registers        : None                                                                
 988               	;unsafe access registers : R18                                                                 
 989               	.macro KER_SLEEP_INIT                                     ;total 0.63uS @8MHz     (  5 clocks) 
 990               	    #ifdef KER_IDLE_AS_SLEEP                                                                   
 991               	        #ifdef KER_SLEEP_MODE_IDLE                                                             
 992               			LDI   R18                , 0x00                   ;set SM[2:0] val        (  1 clock ) 
 993               			#elif defined(KER_SLEEP_MODE_ADC_NR)                                                   
 994               			LDI   R18                , 0x02                   ;set SM[2:0] val        (  1 clock ) 
 995               			#elif defined(KER_SLEEP_MODE_POWER_DOWN)                                               
 996               			LDI   R18                , 0x04                   ;set SM[2:0] val        (  1 clock ) 
 997               	        #elif defined(KER_SLEEP_MODE_POWER_SAVE)                                               
 998               			LDI   R18                , 0x06                   ;set SM[2:0] val        (  1 clock ) 
 999               			#else                                                                                  
 1000               			LDI   R18                , 0x00                   ;set SM[2:0] val        (  1 clock ) 
 1001               			#endif                                                                                 
 1002               			STS   SRSMCR             , R18                    ;set sleep control val  (  2 clocks) 
 1003               			STS   KerBase+OFB_SLCFG  , R18                    ;save sleep control val (  2 clocks) 
 1004               		#endif                                                                                     
 1005               	.endm                                                                                          
 1006               	;;================================kernel sleep config end===================================;; 
 1007               	
 1008               	
 1009               	
 1010               	
 1011               	
 1012               	;;==============================kernel enter sleep mode starting============================;; 
 1013               	;used registers          : None                                                                
 1014               	;arg registers           : None                                                                
 1015               	;return registers        : None                                                                
 1016               	;unsafe access registers : None                                                                
 1017               	.macro KER_ENTER_SLEEP                                    ;total 0.75uS @8MHz     (  6 clocks) 
 1018               	    #ifdef KER_IDLE_AS_SLEEP                                                                   
 1019               			LDS   R18                , SRSMCR                 ;load SMCR              (  2 clocks) 
 1020               			ORI   R18                , 0x01                   ;set SE bit             (  1 clock ) 
 1021               			STS   SRSMCR             , R18                    ;set val                (  2 clocks) 
 1022               			SLEEP                                             ;sleep cpu              (  1 clock ) 
 1023               		#endif                                                                                     
 1024               	.endm                                                                                          
 1025               	;;================================kernel enter sleep mode end===============================;; 
 1026               	
 1027               	
 1028               	
 1029               	
 1030               	
 1031               	;;===============================kernel exit sleep mode starting============================;; 
 1032               	;used registers          : None                                                                
 1033               	;arg registers           : None                                                                
 1034               	;return registers        : None                                                                
 1035               	;unsafe access registers : None                                                                
 1036               	.macro KER_EXIT_SLEEP                                     ;total 0.63uS @8MHz     (  5 clocks) 
 1037               	    #ifdef KER_IDLE_AS_SLEEP                                                                   
 1038               	        LDS   R18                , SRSMCR                 ;load SMCR              (  2 clocks) 
 1039               			ANDI  R18                , 0xFE                   ;clear SE bit           (  1 clock ) 
 1040               			STS   SRSMCR             , R18                    ;set val                (  2 clocks) 
 1041               		#endif                                                                                     
 1042               	.endm                                                                                          
 1043               	;;=================================kernel exit sleep mode end===============================;; 
 1044               	
 1045               	
 1046               	
 1047               	
 1048               	
 1049               	;;=================================ISR execution starting===================================;; 
 1050               	#ifdef  KER_WDT_AS_TICK_SRC                                                                    
 1051               	.global  __vector_6                                                                            
 1052               	    __vector_6:                                           ;total 40.00uS @8MHz    (344 clocks) 
 1053               		    KER_DEBUG_PIN_SET                                 ;debug pin set          (  2 clocks) 
 1054               			KER_EXIT_SLEEP                                    ;exit sleep if enabled  (  5 clocks) 
 1055               	        KER_CONTEXT_SAVE_HANDLER                          ;save context           ( 68 clocks) 
 1056               			KER_SAVE_CURR_TASK_SP                             ;save current task SP   ( 14 clocks) 
 1057               			KER_TICK_INCREMENT                                ;increment tick counter ( 26 clocks) 
 1058               			LDI    R24               , SCH_MODE_HANDLER       ;set sch mode           (  1 clock ) 
 1059               			KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
 1060               			KER_CPU_USAGE                                     ;calc cpu usage         ( 26 clocks) 
 1061               			KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
 1062               			KER_CONTEXT_RESTORE_HANDLER                       ;restore context        ( 67 clocks) 
 1063               		    KER_DEBUG_PIN_CLEAR                               ;debug pin clear        (  2 clocks) 
 1064               			LDS   R18                , SRWDTCSR               ;copy WDTCSR            (  2 clocks) 
 1065               			ORI   R18                , 0x40                   ;set WDIE               (  1 clock ) 
 1066               			STS   SRWDTCSR           , R18                    ;set val                (  2 clocks) 
 1067               			RETI                                              ;return from interrupt  (  4 clocks) 
 1068               	#elif defined(KER_TIMER2_AS_TICK_SRC) || defined(KER_TIMER2_ASYNC_AS_TICK_SRC)                 
 1069               	.global  __vector_7                                                                            
 1070               	    __vector_7:                                           ;total 40.00uS @8MHz    (344 clocks) 
1071:kernel.S      **** 	    KER_DEBUG_PIN_SET                                 ;debug pin set          (  2 clocks) 
1072:kernel.S      **** 		KER_EXIT_SLEEP                                    ;exit sleep if enabled  (  5 clocks) 
1073:kernel.S      ****         KER_CONTEXT_SAVE_HANDLER                          ;save context           ( 68 clocks) 
1074:kernel.S      **** 		KER_SAVE_CURR_TASK_SP                             ;save current task SP   ( 14 clocks) 
1075:kernel.S      **** 		KER_TICK_INCREMENT                                ;increment tick counter ( 26 clocks) 
1076:kernel.S      **** 		LDI    R24               , SCH_MODE_HANDLER       ;set sch mode           (  1 clock ) 
1077:kernel.S      **** 		KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
1078:kernel.S      **** 		KER_CPU_USAGE                                     ;calc cpu usage         ( 26 clocks) 
1079:kernel.S      **** 		KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
1080:kernel.S      **** 		KER_CONTEXT_RESTORE_HANDLER                       ;restore context        ( 67 clocks) 
1081:kernel.S      **** 	    KER_DEBUG_PIN_CLEAR                               ;debug pin clear        (  2 clocks) 
1082:kernel.S      **** 		RETI                                              ;return from interrupt  (  4 clocks) 
 1083               	#else                                                                                          
 1084               	.global  __vector_7                                                                            
 1085               	    __vector_7:                                           ;total 40.00uS @8MHz    (344 clocks) 
 1086               		    KER_DEBUG_PIN_SET                                 ;debug pin set          (  2 clocks) 
 1087               			KER_EXIT_SLEEP                                    ;exit sleep if enabled  (  5 clocks) 
 1088               	        KER_CONTEXT_SAVE_HANDLER                          ;save context           ( 68 clocks) 
 1089               			KER_SAVE_CURR_TASK_SP                             ;save current task SP   ( 14 clocks) 
 1090               			KER_TICK_INCREMENT                                ;increment tick counter ( 26 clocks) 
 1091               			LDI    R24               , SCH_MODE_HANDLER       ;set sch mode           (  1 clock ) 
 1092               			KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
 1093               			KER_CPU_USAGE                                     ;calc cpu usage         ( 26 clocks) 
 1094               			KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
 1095               			KER_CONTEXT_RESTORE_HANDLER                       ;restore context        ( 67 clocks) 
 1096               		    KER_DEBUG_PIN_CLEAR                               ;debug pin clear        (  2 clocks) 
 1097               			RETI                                              ;return from interrupt  (  4 clocks) 
 1098               	#endif                                                                                         
 1099               	;;====================================ISR execution end=====================================;; 
 1100               	
 1101               	
 1102               	
 1103               	
 1104               	
 1105               	;;================================SysTick reg init starting=================================;; 
 1106               	;used registers          : R18, R19, R22, R24, R26(XL), R27(XH), R30(ZL), R31(ZH)              
 1107               	;arg registers           : R24(Prescaler), R22(ReloadVal)                                      
 1108               	;return registers        : None                                                                
 1109               	;unsafe access registers : R18, R19, R22, R24, R26(XL), R27(XH), R30(ZL), R31(ZH)              
 1110               	Kernel_Tick_Init:                                         ;total 11.50uS @8MHz    ( 92 clocks) 
1111:kernel.S      ****         CLI                                               ;disable global int     (  1 clock ) 
1112:kernel.S      **** 		KER_DEBUG_PIN_INIT                                ;debug pin init         (  4 clocks) 
1113:kernel.S      ****         KER_PUSH_MSP_ZP                                   ;push MSP and ZP        ( 18 clocks) 
 1114               			;clear reg                                                                             
1115:kernel.S      **** 		LDI   R18                , 0x00                   ;set 0x00 to R18        (  1 clock ) 
 1116               			;clear tick counter                                                                    
1117:kernel.S      **** 		STS   KerBase+OFB_TICK0  , R18                    ;clear  KerBase[0]      (  2 clocks) 
1118:kernel.S      **** 		STS   KerBase+OFB_TICK1  , R18                    ;clear  KerBase[1]      (  2 clocks) 
1119:kernel.S      **** 		STS   KerBase+OFB_TICK2  , R18                    ;clear  KerBase[2]      (  2 clocks) 
1120:kernel.S      **** 		STS   KerBase+OFB_TICK3  , R18                    ;clear  KerBase[3]      (  2 clocks) 
1121:kernel.S      **** 		STS   KerBase+OFB_TICK4  , R18                    ;clear  KerBase[4]      (  2 clocks) 
 1122               			;clear system registers                                                                
1123:kernel.S      **** 		STS   KerBase+OFB_PRS    , R18                    ;clear  KerBase[5]      (  2 clocks) 
1124:kernel.S      **** 		STS   KerBase+OFB_RLD    , R18                    ;clear  KerBase[6]      (  2 clocks) 
1125:kernel.S      **** 		STS   KerBase+OFB_TID    , R18                    ;clear  KerBase[7]      (  2 clocks) 
1126:kernel.S      **** 		STS   KerBase+OFB_NTSK   , R18                    ;clear  KerBase[8]      (  2 clocks) 
1127:kernel.S      **** 		STS   KerBase+OFB_LPR    , R18                    ;clear  KerBase[9]      (  2 clocks) 
1128:kernel.S      ****         STS   KerBase+OFB_PTID   , R18                    ;clear  KerBase[10]     (  2 clocks) 
1129:kernel.S      **** 		STS   KerBase+OFB_UTC    , R18                    ;clear  KerBase[11]     (  2 clocks) 
1130:kernel.S      **** 		STS   KerBase+OFB_UATC   , R18                    ;clear  KerBase[12]     (  2 clocks) 
1131:kernel.S      **** 		STS   KerBase+OFB_USAGE  , R18                    ;clear  KerBase[13]     (  2 clocks) 
 1132               			;clear all timer registers                                                             
 1133               	        #ifdef KER_WDT_AS_TICK_SRC                                                             
 1134               			KER_WDT_DISABLE                                                                        
 1135               			#elif defined(KER_TIMER2_AS_TICK_SRC) || defined(KER_TIMER2_ASYNC_AS_TICK_SRC)         
1136:kernel.S      ****         KER_TIMER2_DISABLE                                                                     
 1137               			#else                                                                                  
 1138               			KER_TIMER2_DISABLE                                                                     
 1139               			#endif                                                                                 
 1140               			;save values for future use                                                            
1141:kernel.S      **** 		STS   KerBase+OFB_PRS    , R24                    ;KerBase[5] prescaler   (  2 clocks) 
1142:kernel.S      **** 		STS   KerBase+OFB_RLD    , R22                    ;KerBase[6] reload val  (  2 clocks) 
1143:kernel.S      ****         KER_POP_MSP_ZP                                    ;pop MSP and ZP         ( 18 clocks) 
1144:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1145               	;;===================================SysTick reg init end===================================;; 
 1146               	
 1147               	
 1148               	
 1149               	
 1150               	
 1151               	;;===============================kernel task create starting================================;; 
 1152               	;used registers          : R18, R19, R20, R22, R24, R25, R26(XL), R27(XH), R30(ZL), R31(ZH)    
 1153               	;arg registers           : R25:R24(FuncPtr), R22(TaskPriority)                                 
 1154               	;return registers        : None                                                                
 1155               	;unsafe access registers : R18, R19, R20, R22, R24, R25, R26(XL), R27(XH), R30(ZL), R31(ZH)    
 1156               	Kernel_Task_Create:                                       ;total 21.50uS @8MHz    (172 clocks) 
1157:kernel.S      ****         KER_PUSH_MSP_ZP                                   ;push MSP and ZP        ( 18 clocks) 
 1158               			;set priority to KerSchPr+task_id                                                      
1159:kernel.S      **** 		LDI   R30                , lo8(KerSchPr)          ;load low byte          (  1 clock ) 
1160:kernel.S      **** 		LDI   R31                , hi8(KerSchPr)          ;load high byte         (  1 clock ) 
1161:kernel.S      **** 		KER_CALC_ADDR_OFF_BYTES                           ;calc offset            (  5 clocks) 
1162:kernel.S      **** 		ST    Z                  , R22                    ;save priority          (  2 clocks) 
 1163               			;set task status to KerSchSts+task_id                                                  
1164:kernel.S      **** 		LDI   R30                , lo8(KerSchSts)         ;load low byte          (  1 clock ) 
1165:kernel.S      **** 		LDI   R31                , hi8(KerSchSts)         ;load high byte         (  1 clock ) 
1166:kernel.S      **** 		KER_CALC_ADDR_OFF_BYTES                           ;calc offset            (  5 clocks) 
1167:kernel.S      **** 		LDI   R18                , TASK_READY             ;set status as ready    (  1 clock ) 
1168:kernel.S      **** 		ST    Z                  , R18                    ;save status            (  2 clocks) 
 1169               			;stack pointer for current task (KerStack + KER_STK_SZ*(task_id+1) - 1) ->stack top    
1170:kernel.S      **** 		LDS   R18                , KerBase+OFB_TID        ;load task_id           (  2 clocks) 
1171:kernel.S      **** 		INC   R18                                         ;increment task_id      (  1 clock ) 
1172:kernel.S      **** 		LDI   R19                , KER_STK_SZ             ;load stack size        (  1 clock ) 
1173:kernel.S      **** 		MUL   R18                , R19                    ;multiply to get offset (  2 clocks) 
1174:kernel.S      **** 		MOV   R30                , R0                     ;load multiplied low    (  1 clocks) 
1175:kernel.S      **** 		MOV   R31                , R1                     ;load multiplied high   (  1 clocks) 
1176:kernel.S      **** 		SBIW  R30                , 0x01                   ;dec multiplied val-1   (  2 clocks) 
1177:kernel.S      **** 		CLR   R1                                          ;gcc expects cleared    (  1 clock ) 
1178:kernel.S      **** 		LDI   R18                , lo8(KerStack)          ;load base addr low     (  1 clock ) 
1179:kernel.S      **** 		LDI   R19                , hi8(KerStack)          ;load base addr high    (  1 clock ) 
1180:kernel.S      **** 		ADD   R30                , R18                    ;add low bytes          (  1 clock ) 
1181:kernel.S      **** 		ADC   R31                , R19                    ;add high bytes+carry   (  1 clock ) 
1182:kernel.S      **** 		OUT   IOSPL              , R30                    ;load SPL               (  1 clock ) 
1183:kernel.S      ****         OUT   IOSPH              , R31                    ;load SPH               (  1 clock ) 
 1184               			;function argument directly returns word address                                       
1185:kernel.S      **** 	    PUSH  R24                                         ;push word addr low     (  2 clocks) 
1186:kernel.S      **** 		PUSH  R25                                         ;push word addr high    (  2 clocks) 
 1187               			;push context to stack of this task                                                    
1188:kernel.S      **** 		KER_CONTEXT_SAVE_HANDLER                          ;save context           ( 68 clocks) 
 1189               			;read stack pointer of current task (necessary when restore)                           
1190:kernel.S      **** 		IN    R18                , IOSPL                  ;read SPL               (  1 clock ) 
1191:kernel.S      ****         IN    R19                , IOSPH                  ;read SPH               (  1 clock ) 
 1192               			;calculate the address where current task's SP will be stored and store SP             
1193:kernel.S      **** 		LDS   R20                , KerBase+OFB_TID        ;load task_id           (  2 clocks) 
1194:kernel.S      **** 		LSL   R20                                         ;left shift to multiply (  1 clock ) 
1195:kernel.S      **** 		LDI   R30                , lo8(KerPSP)            ;fetch base pos low     (  1 clock ) 
1196:kernel.S      **** 		LDI   R31                , hi8(KerPSP)            ;fetch base pos high    (  1 clock ) 
1197:kernel.S      **** 		ADD   R30                , R20                    ;add offset to array    (  1 clock ) 
1198:kernel.S      **** 		LDI   R20                , 0x00                   ;clear reg              (  1 clock ) 
1199:kernel.S      **** 		ADC   R31                , R20                    ;add carry if any       (  1 clock ) 
1200:kernel.S      **** 		ST    Z+                 , R18                    ;SPL at KerPSp+offset   (  2 clocks) 
1201:kernel.S      **** 		ST    Z                  , R19                    ;SPH at KerPSp+offset   (  2 clocks) 
 1202               			;increment task_id                                                                     
1203:kernel.S      **** 		LDS   R18                , KerBase+OFB_TID        ;load task_id           (  2 clocks) 
1204:kernel.S      **** 		INC   R18                                         ;increment task_id      (  1 clock ) 
1205:kernel.S      **** 		STS   KerBase+OFB_TID    , R18                    ;store task_id          (  2 clocks) 
 1206               			;increment ntask                                                                       
1207:kernel.S      **** 		LDS   R18                , KerBase+OFB_NTSK       ;load ntask             (  2 clocks) 
1208:kernel.S      **** 		INC   R18                                         ;increment ntask        (  1 clock ) 
1209:kernel.S      **** 		STS   KerBase+OFB_NTSK   , R18                    ;store ntask            (  2 clocks) 
1210:kernel.S      **** 		KER_POP_MSP_ZP                                    ;pop MSP and ZP         ( 18 clocks) 
1211:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1212               	;;==================================kernel task create end==================================;; 
 1213               	
 1214               	
 1215               	
 1216               	
 1217               	
 1218               	;;=================================kernel start tasks starting==============================;; 
 1219               	;used registers          : R0~R31                                                              
 1220               	;arg registers           : None                                                                
 1221               	;return registers        : None                                                                
 1222               	;unsafe access registers : R18, R19, R20, R24, R25, R30(ZL), R31(ZH)                           
 1223               	Kernel_Start_Tasks:                                       ;total 25.63uS @8MHz    (205 clocks) 
1224:kernel.S      **** 		LDI    R24               , SCH_MODE_THREAD        ;set sch mode           (  1 clock ) 
1225:kernel.S      **** 		KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
1226:kernel.S      **** 		KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
1227:kernel.S      **** 		KER_CONTEXT_RESTORE_THREAD                        ;restore context        ( 68 clocks) 
 1228               			;config timer for system tick                                                          
1229:kernel.S      **** 		KER_TIMER_INIT                                    ;init timer, int enable ( 12 clocks) 
 1230               			;execute return to jump to highest priority task                                       
1231:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1232               	;;==================================kernel start tasks end==================================;; 
 1233               	
 1234               	
 1235               	
 1236               	
 1237               	
 1238               	;;===================================kernel init starting===================================;; 
 1239               	;used registers          : R1, R18, R19, R22, R24, R25, R26(XL), R27(XH), R30(ZL), R31(ZH)     
 1240               	;arg registers           : None                                                                
 1241               	;return registers        : None                                                                
 1242               	;unsafe access registers : R1, R18, R19, R22, R24, R25, R26(XL), R27(XH), R30(ZL), R31(ZH)     
 1243               	Kernel_Init:                                              ;total 39.75uS @8MHz    (318 clocks) 
1244:kernel.S      **** 		CLR   R1                                          ;gcc expects            (  1 clock ) 
 1245               	        ;store stack top (for MSP) addr to KerSSZ+OFM_MSPI0:1                                  
1246:kernel.S      **** 		LDI   R18                , lo8(KerSSZ+OFM_MSPS)   ;load low address       (  1 clock ) 
1247:kernel.S      **** 		LDI   R19                , hi8(KerSSZ+OFM_MSPS)   ;load high address      (  1 clock ) 
1248:kernel.S      ****         STS   KerSSZ+OFM_MSPI+0  , R18                    ;set mspi to stack top  (  2 clocks) 
1249:kernel.S      **** 		STS   KerSSZ+OFM_MSPI+1  , R19                    ;set mspi to stack top  (  2 clocks) 
1250:kernel.S      **** 		KER_PUSH_MSP_ZP                                   ;push MSP and ZP        ( 18 clocks) 
 1251               			;init timer for kernel                                                                 
1252:kernel.S      **** 		LDI   R24                , 0x04                   ;set prescaler          (  1 clock ) 
1253:kernel.S      **** 		LDI   R22                , 0x7D                   ;set reload val         (  1 clock ) 
1254:kernel.S      **** 		CALL  Kernel_Tick_Init                            ;init timer             ( 92 clocks) 
 1255               			;create idle task at task_id 0, priority 0xFF (lowest)                                 
1256:kernel.S      **** 		LDI   R24                , lo8(Kernel_Task_Idle)  ;load func addr low     (  1 clock ) 
1257:kernel.S      **** 		LDI   R25                , hi8(Kernel_Task_Idle)  ;load func addr high    (  1 clock ) 
1258:kernel.S      **** 		LSR   R25                                         ;right shift to divide  (  1 clock ) 
1259:kernel.S      **** 		ROR   R24                                         ;rotate right th carry  (  1 clock ) 
1260:kernel.S      **** 		LDI   R22                , 0xFF                   ;set max val            (  1 clock ) 
1261:kernel.S      **** 		CALL  Kernel_Task_Create                          ;init idle task         (172 clocks) 
1262:kernel.S      **** 		KER_POP_MSP_ZP                                    ;pop MSP and ZP         ( 18 clocks) 
 1263               			;execute return to jump to task0, pushed while task init                               
1264:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1265               	;;======================================kernel init end=====================================;; 
 1266               	
 1267               	
 1268               	
 1269               	
 1270               	
 1271               	;;=================================kernel idle task starting================================;; 
 1272               	;used registers          : None                                                                
 1273               	;arg registers           : None                                                                
 1274               	;return registers        : None                                                                
 1275               	;unsafe access registers : None                                                                
 1276               	Kernel_Task_Idle:                                                                              
1277:kernel.S      **** 	    KER_SLEEP_INIT                                    ;sleep init             (  5 clocks) 
 1278               	    _IDLE_LOOP:                                           ;forever loop                        
1279:kernel.S      **** 	    KER_DISABLE_ANALOG_DOMAIN                         ;disable adc, ac        ( 10 clocks) 
 1280               			#ifdef KER_CALL_FUNC_BEFORE_SLEEP                                                      
 1281               			CALL  Kernel_PreSleep_Hook                        ;call func before sleep (  8 clocks) 
 1282               			#endif                                                                                 
1283:kernel.S      **** 	    KER_ENTER_SLEEP                                   ;enter sleep mode       (  6 clocks) 
1284:kernel.S      **** 		JMP   _IDLE_LOOP                                  ;jump to loop start     (  2 clocks) 
 1285               	;;==================================kernel idle task end====================================;; 
 1286               	
 1287               	
 1288               	
 1289               	
 1290               	
 1291               	;;================================kernel task sleep starting================================;; 
 1292               	;used registers          : R0~R31                                                              
 1293               	;arg registers           : R25:R24(SleepTime)                                                  
 1294               	;return registers        : None                                                                
 1295               	;unsafe access registers : R18, R19, R20, R24, R25, R30(ZL), R31(ZH)                           
 1296               	Kernel_Task_Sleep:                                        ;total 37.25uS @8MHz    (298 clocks) 
 1297               	        ;save current context                                                                  
1298:kernel.S      ****         KER_CONTEXT_SAVE_THREAD                           ;save context           ( 69 clocks) 
1299:kernel.S      **** 		KER_SAVE_CURR_TASK_SP                             ;save current task SP   ( 14 clocks) 
 1300               			;create next task wakeup time (args R25:R24)                                           
1301:kernel.S      **** 		LDI   R30                , lo8(KerSchSlp)         ;load low byte          (  1 clock ) 
1302:kernel.S      **** 		LDI   R31                , hi8(KerSchSlp)         ;load high byte         (  1 clock ) 
1303:kernel.S      **** 		KER_CALC_ADDR_OFF_WORD                            ;offset calc            (  6 clocks) 
1304:kernel.S      **** 		STD   Z+0                , R24                    ;save sleep time low    (  2 clocks) 
1305:kernel.S      **** 		STD   Z+1                , R25                    ;save sleep time high   (  2 clocks) 
 1306               			;update task scheduler status as blocked                                               
1307:kernel.S      **** 		LDI   R30                , lo8(KerSchSts)         ;load low byte          (  1 clock ) 
1308:kernel.S      **** 		LDI   R31                , hi8(KerSchSts)         ;load high byte         (  1 clock ) 
1309:kernel.S      **** 		KER_CALC_ADDR_OFF_BYTES                           ;offset calc            (  5 clocks) 
1310:kernel.S      ****         LDI   R18                , TASK_BLOCKED           ;block task until cnt=0 (  1 clock ) 
1311:kernel.S      **** 		STD   Z+0                , R18                    ;save block flag        (  2 clocks) 
 1312               			;run scheduler, load next task sp, restore context                                     
1313:kernel.S      **** 		LDI    R24               , SCH_MODE_THREAD        ;set sch mode           (  1 clock ) 
1314:kernel.S      **** 		KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
1315:kernel.S      **** 		KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
1316:kernel.S      **** 		KER_CONTEXT_RESTORE_THREAD                        ;restore context        ( 68 clocks) 
1317:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1318               	;;=================================kernel task sleep end====================================;; 
 1319               	
 1320               	
 1321               	
 1322               	
 1323               	
 1324               	;;========================kernel task constant latency starting=============================;; 
 1325               	;used registers          : R18, R24, R25, R30(ZL), R31(ZH)                                     
 1326               	;arg registers           : R25:R24(SleepTime)                                                  
 1327               	;return registers        : None                                                                
 1328               	;unsafe access registers : R18, R24, R25, R30(ZL), R31(ZH)                                     
 1329               	Kernel_Task_Constant_Latency:                             ;total 3.50uS @8MHz     ( 28 clocks) 
 1330               			;create next task wakeup time (args R25:R24)                                           
1331:kernel.S      **** 		CLI                                               ;disable interrupt      (  1 clock ) 
1332:kernel.S      **** 		LDI   R30                , lo8(KerSchSlp)         ;load low byte          (  1 clock ) 
1333:kernel.S      **** 		LDI   R31                , hi8(KerSchSlp)         ;load high byte         (  1 clock ) 
1334:kernel.S      **** 		KER_CALC_ADDR_OFF_WORD                            ;offset calc            (  6 clocks) 
1335:kernel.S      **** 		STD   Z+0                , R24                    ;save sleep time low    (  2 clocks) 
1336:kernel.S      **** 		STD   Z+1                , R25                    ;save sleep time high   (  2 clocks) 
 1337               			;update task scheduler status as constant latency                                      
1338:kernel.S      **** 		LDI   R30                , lo8(KerSchSts)         ;load low byte          (  1 clock ) 
1339:kernel.S      **** 		LDI   R31                , hi8(KerSchSts)         ;load high byte         (  1 clock ) 
1340:kernel.S      **** 		KER_CALC_ADDR_OFF_BYTES                           ;offset calc            (  5 clocks) 
1341:kernel.S      ****         LDI   R18                , TASK_CONS_LAT          ;save as cons_lat       (  1 clock ) 
1342:kernel.S      **** 		STD   Z+0                , R18                    ;save block flag        (  2 clocks) 
1343:kernel.S      **** 		SEI                                               ;enable interrupt       (  1 clock ) 
1344:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1345               	;;=============================kernel task constant latency end=============================;; 
 1346               	
 1347               	
 1348               	
 1349               	
 1350               	
 1351               	;;=======================kernel task constant latency sleep starting========================;; 
 1352               	;used registers          : R0~R31                                                              
 1353               	;arg registers           : R25:R24(SleepTime)                                                  
 1354               	;return registers        : None                                                                
 1355               	;unsafe access registers : R18, R19, R20, R24, R25, R30(ZL), R31(ZH)                           
 1356               	Kernel_Task_Constant_Latency_Sleep:                       ;total 35.75uS @8MHz    (286 clocks) 
 1357               			;save current context                                                                  
1358:kernel.S      ****         KER_CONTEXT_SAVE_THREAD                           ;save context           ( 69 clocks) 
1359:kernel.S      **** 		KER_SAVE_CURR_TASK_SP                             ;save current task SP   ( 14 clocks) 
 1360               			;update task scheduler status as blocked                                               
1361:kernel.S      **** 		LDI   R30                , lo8(KerSchSts)         ;load low byte          (  1 clock ) 
1362:kernel.S      **** 		LDI   R31                , hi8(KerSchSts)         ;load high byte         (  1 clock ) 
1363:kernel.S      **** 		KER_CALC_ADDR_OFF_BYTES                           ;offset calc            (  5 clocks) 
1364:kernel.S      ****         LDI   R18                , TASK_BLOCKED           ;blocked until cnt=0    (  1 clock ) 
1365:kernel.S      **** 		STD   Z+0                , R18                    ;save block flag        (  2 clocks) 
 1366               			;run scheduler, load next task sp, restore context                                     
1367:kernel.S      **** 		LDI    R24               , SCH_MODE_THREAD        ;set sch mode           (  1 clock ) 
1368:kernel.S      **** 		KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
1369:kernel.S      **** 		KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
1370:kernel.S      **** 		KER_CONTEXT_RESTORE_THREAD                        ;restore context        ( 68 clocks) 
1371:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1372               	;;=============================kernel task constant latency end=============================;; 
 1373               	
 1374               	
 1375               	
 1376               	
 1377               	
 1378               	;;=========================kernel call func before sleep starting===========================;; 
 1379               	;used registers          : R24, R25, R30(ZL), R31(ZH)                                          
 1380               	;arg registers           : R25:R24(FunctionPtr)                                                
 1381               	;return registers        : None                                                                
 1382               	;unsafe access registers : R24, R25, R30(ZL), R31(ZH)                                          
 1383               	Kernel_PreSleep_Hook:                                     ;total 1.00uS @8MHz     (  8 clocks) 
1384:kernel.S      ****         MOVW  R30                , R24                    ;move pointer to Z      (  1 clock ) 
1385:kernel.S      **** 		ICALL                                             ;indirect call          (  3 clocks) 
1386:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1387               	;;============================kernel call func before sleep end=============================;; 
 1388               	
 1389               	
 1390               	
 1391               	
 1392               	
 1393               	;;========================kernel main clock prescaler set starting==========================;; 
 1394               	;used registers          : R18, R24                                                            
 1395               	;arg registers           : R24(prescaler reg val)                                              
 1396               	;return registers        : None                                                                
 1397               	;unsafe access registers : R18, R24                                                            
 1398               	Kernel_Clock_Prescale:                                    ;total 1.75uS @8MHz     ( 14 clocks) 
1399:kernel.S      ****         LDS   R18                , SRSREG                 ;load sreg              (  2 clocks)
1400:kernel.S      **** 		CLI                                               ;disable interrupt      (  1 clock )
1401:kernel.S      **** 		LDI   R19                , 0x80                   ;set CLKPCE             (  1 clock ) 
1402:kernel.S      **** 		STS   SRCLKPR            , R19                    ;store val              (  2 clocks) 
1403:kernel.S      **** 		STS   SRCLKPR            , R24                    ;store val              (  2 clocks)
1404:kernel.S      ****         STS   SRSREG             , R18                    ;store val              (  2 clocks) 
1405:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1406               	;;==========================kernel main clock prescaler set end=============================;; 
 1407               	
 1408               	
 1409               	
 1410               	
 1411               	
 1412               	;;===========================kernel task sleep time get starting============================;; 
 1413               	;used registers          : R18, R24, R25, R30(ZL), R31(ZH)                                     
 1414               	;arg registers           : R24(TaskID)                                                         
 1415               	;return registers        : R25:R24(SleepTime)                                                  
 1416               	;unsafe access registers : R18, R24, R25, R30(ZL), R31(ZH)                                     
 1417               	Kernel_Task_Sleep_Time_Get:                               ;total 1.88uS @8MHz     ( 15 clocks) 
1418:kernel.S      **** 		MOV   R18                , R24                    ;copy                   (  1 clock ) 
1419:kernel.S      **** 		LSL   R18                                         ;x2                     (  1 clock ) 
1420:kernel.S      **** 		LDI   R30                , lo8(KerSchSlp)         ;load low byte          (  1 clock ) 
1421:kernel.S      **** 		LDI   R31                , hi8(KerSchSlp)         ;load high byte         (  1 clock ) 
1422:kernel.S      **** 		ADD   R30                , R18                    ;add low bytes          (  1 clock ) 
1423:kernel.S      **** 		LDI   R18                , 0x00                   ;load 0                 (  1 clock ) 
1424:kernel.S      **** 		ADC   R31                , R18                    ;add high byte+carry    (  1 clock ) 
1425:kernel.S      **** 		LDD   R24                , Z+0                    ;load sleep time        (  2 clocks) 
1426:kernel.S      **** 		LDD   R25                , Z+1                    ;load sleep time        (  2 clocks) 
1427:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1428               	;;==============================kernel task sleep time get end==============================;; 
 1429               	
 1430               	
 1431               	
 1432               	
 1433               	
 1434               	;;==============================kernel task status get starting=============================;; 
 1435               	;used registers          : R18, R24, R30(ZL), R31(ZH)                                          
 1436               	;arg registers           : R24(TaskID)                                                         
 1437               	;return registers        : R24(TaskSts)                                                        
 1438               	;unsafe access registers : R18, R24, R30(ZL), R31(ZH)                                          
 1439               	Kernel_Task_Status_Get:                                   ;total 1.50uS @8MHz     ( 12 clocks) 
1440:kernel.S      **** 		MOV   R18                , R24                    ;copy                   (  1 clock ) 
1441:kernel.S      **** 		LDI   R30                , lo8(KerSchSts)         ;load low byte          (  1 clock ) 
1442:kernel.S      **** 		LDI   R31                , hi8(KerSchSts)         ;load high byte         (  1 clock ) 
1443:kernel.S      **** 		ADD   R30                , R18                    ;add low bytes          (  1 clock ) 
1444:kernel.S      **** 		LDI   R18                , 0x00                   ;load 0                 (  1 clock ) 
1445:kernel.S      **** 		ADC   R31                , R18                    ;add high byte+carry    (  1 clock ) 
1446:kernel.S      **** 		LD    R24                , Z                      ;load task status       (  2 clocks) 
1447:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1448               	;;================================kernel task status get end================================;; 
 1449               	
 1450               	
 1451               	
 1452               	
 1453               	
 1454               	;;================================kernel ntask get starting=================================;; 
 1455               	;used registers          : R24                                                                 
 1456               	;arg registers           : None                                                                
 1457               	;return registers        : R24(NTask)                                                          
 1458               	;unsafe access registers : R24                                                                 
 1459               	Kernel_NTask_Get:                                         ;total 0.75uS @8MHz     (  6 clocks) 
1460:kernel.S      **** 		LDS   R24                 , KerBase+OFB_NTSK      ;load ntask             (  2 clock ) 
1461:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1462               	;;===================================kernel ntask get end===================================;; 
 1463               	
 1464               	
 1465               	
 1466               	
 1467               	
 1468               	;;=============================kernel task priority get starting============================;; 
 1469               	;used registers          : R18, R24, R30(ZL), R31(ZH)                                          
 1470               	;arg registers           : R24(TaskID)                                                         
 1471               	;return registers        : R24(TaskPriority)                                                   
 1472               	;unsafe access registers : R18, R24, R30(ZL), R31(ZH)                                          
 1473               	Kernel_Task_Prio_Get:                                     ;total 1.50uS @8MHz     ( 12 clocks) 
 1474               			;get priority of the task id, arg (task_id->R24), return R24                           
1475:kernel.S      **** 		MOV   R18                , R24                    ;copy task_id           (  1 clock ) 
1476:kernel.S      **** 		LDI   R30                , lo8(KerSchPr)          ;load low byte          (  1 clock ) 
1477:kernel.S      **** 		LDI   R31                , hi8(KerSchPr)          ;load high byte         (  1 clock ) 
1478:kernel.S      **** 		ADD   R30                , R18                    ;add low bytes          (  1 clock ) 
1479:kernel.S      **** 		LDI   R18                , 0x00                   ;clear reg              (  1 clock ) 
1480:kernel.S      **** 		ADC   R31                , R18                    ;add high byte+carry    (  1 clock ) 
1481:kernel.S      **** 		LD    R24                , Z                      ;load priority          (  2 clocks) 
1482:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1483               	;;================================kernel task priority get end==============================;; 
 1484               	
 1485               	
 1486               	
 1487               	
 1488               	
 1489               	;;============================kernel lowest priority get starting===========================;; 
 1490               	;used registers          : R24                                                                 
 1491               	;arg registers           : None                                                                
 1492               	;return registers        : R24(LowestPriorityVal)                                              
 1493               	;unsafe access registers : R24                                                                 
 1494               	Kernel_Lowest_Prio_Get:                                   ;total 0.75uS @8MHz     (  6 clocks) 
1495:kernel.S      **** 		LDS   R24                , KerBase+OFB_LPR        ;load lowest priority   (  2 clocks) 
1496:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1497               	;;===============================kernel lowest priority get end=============================;; 
 1498               	
 1499               	
 1500               	
 1501               	
 1502               	
 1503               	;;===========================kernel high priority task id starting==========================;; 
 1504               	;used registers          : R24                                                                 
 1505               	;arg registers           : None                                                                
 1506               	;return registers        : R24(HighstPriorityTaskID)->UserTaskID (Excluding Idle Task)         
 1507               	;unsafe access registers : R24                                                                 
 1508               	Kernel_High_Prio_Task_ID_Get:                             ;total 0.88uS @8MHz     (  7 clocks) 
1509:kernel.S      **** 		LDS   R24                , KerBase+OFB_PTID       ;load priority tak_id   (  2 clocks) 
1510:kernel.S      **** 		DEC   R24                                         ;decrement by 1         (  1 clock ) 
1511:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1512               	;;==============================kernel high priority task id end============================;; 
 1513               	
 1514               	
 1515               	
 1516               	
 1517               	
 1518               	;;=========================kernel abs high priority task id starting========================;; 
 1519               	;used registers          : R24                                                                 
 1520               	;arg registers           : None                                                                
 1521               	;return registers        : R24(HighstPriorityTaskID)->AbsoluteTaskID (Including Idle Task)     
 1522               	;unsafe access registers : R24                                                                 
 1523               	Kernel_Abs_High_Prio_Task_ID_Get:                         ;total 0.75uS @8MHz     (  6 clocks) 
1524:kernel.S      **** 		LDS   R24                , KerBase+OFB_PTID       ;load priority tak_id   (  2 clocks) 
1525:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1526               	;;============================kernel abs high priority task id end==========================;; 
 1527               	
 1528               	
 1529               	
 1530               	
 1531               	
 1532               	;;================================kernel cpu usage get starting=============================;; 
 1533               	;used registers          : R24                                                                 
 1534               	;arg registers           : None                                                                
 1535               	;return registers        : R24(CurrentCpuUsage)->In percentage                                 
 1536               	;unsafe access registers : R24                                                                 
 1537               	Kernel_CPU_Usage_Get:                                     ;total 0.75uS @8MHz     (  6 clocks) 
 1538               			;get cpu usage, return R24                                                             
1539:kernel.S      **** 		LDS   R24                , KerBase+OFB_USAGE      ;load cpu usage         (  2 clocks) 
1540:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1541               	;;==================================kernel cpu usage get end================================;; 
 1542               	
 1543               	
 1544               	
 1545               	
 1546               	
 1547               	;;=================================kernel tick val get starting=============================;; 
 1548               	;used registers          : R22, R23, R24, R25                                                  
 1549               	;arg registers           : None                                                                
 1550               	;return registers        : R25:R22(TickVal)                                                    
 1551               	;unsafe access registers : R22, R23, R24, R25                                                  
 1552               	Kernel_Tick_Val_Get:                                      ;total 0.75uS @8MHz     (  6 clocks) 
1553:kernel.S      ****         IN    R18                , IOSREG                 ;save SREG              (  1 clock ) 
1554:kernel.S      **** 		CLI                                               ;disable interrupt      (  1 clock ) 
1555:kernel.S      **** 		LDS   R22                , KerBase+OFB_TICK0      ;load tick count        (  2 clocks) 
1556:kernel.S      **** 		LDS   R23                , KerBase+OFB_TICK1      ;load tick count        (  2 clocks) 
1557:kernel.S      **** 		LDS   R24                , KerBase+OFB_TICK2      ;load tick count        (  2 clocks) 
1558:kernel.S      **** 		LDS   R25                , KerBase+OFB_TICK3      ;load tick count        (  2 clocks) 
1559:kernel.S      **** 		OUT   IOSREG             , R18                    ;restore SREG           (  1 clock ) 
1560:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1561               	;;===================================kernel tick val get end================================;; 
 1562               	
 1563               	
 1564               	
 1565               	
 1566               	
 1567               	
 1568               	
 1569               	;;================================run scheduler starting====================================;; 
 1570               	;used registers          : R18, R19, R20, R21, R24, R25, R30(ZL), R31(ZH)                      
 1571               	;arg registers           : R24 (SCH_MODE_HANDLER/SCH_MODE_THREAD)                              
 1572               	;return registers        : None                                                                
 1573               	;unsafe access registers : R18, R19, R20, R21, R24, R25, R30(ZL), R31(ZH)                      
 1574               	;.macro  KER_RUN_SCHEDULER                                 ;total 13.25uS @8MHz    (106 clocks) 
 1575               	;		LDI   R16                , 0x00                   ;task_id from 0         (  1 clock ) 
 1576               	;		LDS   R17                , KerBase+OFB_NTSK       ;load ntask             (  2 clocks) 
 1577               	;		LDI   R18                , 0xFF                   ;lowest priority        (  1 clock ) 
 1578               	;		LDI   R19                , 0x00                   ;hi prio task_id=0      (  1 clock ) 
 1579               	;		LDI   R26                , lo8(KerSchSts)         ;fetch base pos low     (  1 clock ) 
 1580               	;		LDI   R27                , hi8(KerSchSts)         ;fetch base pos high    (  1 clock ) 
 1581               	;		LDI   R28                , lo8(KerSchPr)          ;load low addr          (  1 clock ) 
 1582               	;		LDI   R29                , hi8(KerSchPr)          ;load high addr         (  1 clock ) 
 1583               	;		LDI   R30                , lo8(KerSchSlp)         ;fetch base pos low     (  1 clock ) 
 1584               	;		LDI   R31                , hi8(KerSchSlp)         ;fetch base pos high    (  1 clock ) 
 1585               	;	_KER_SCH_LOOP\@:                                                                           
 1586               	;	    LDD   R24                , Z+0                    ;load val low byte      (  2 clocks) 
 1587               	;		LDD   R25                , Z+1                    ;load val high byte     (  2 clocks) 
 1588               	;       MOV   R20                , R24                    ;copy reg               (  1 clock ) 
 1589               	;		OR    R20                , R25                    ;or two reg             (  1 clock ) 
 1590               	;		BREQ  _VAL_NULL\@                                                                      
 1591               	;		CPI   R21                , SCH_MODE_THREAD        ;R21 argument           (  1 clock ) 
 1592               	;		BREQ  _VAL_NOT_NULL\@                                                                  
 1593               	;		SBIW  R24                , 0x01                   ;sutract sleep val      (  2 clocks) 
 1594               	;		STD   Z+0                , R24                    ;store low byte         (  2 clocks) 
 1595               	;		STD   Z+1                , R25                    ;store high byte        (  2 clocks) 
 1596               	;		MOV   R20                , R24                    ;copy                   (  1 clock ) 
 1597               	;		OR    R20                , R25                    ;or high & low bytes    (  1 clock ) 
 1598               	;		BRNE  _VAL_NOT_NULL\@                             ;val!=0                 (  2 clocks) 
 1599               	;	_VAL_NULL\@:                                                                               
 1600               	;		LDI   R20                , TASK_READY             ;set TASK_READY         (  1 clock ) 
 1601               	;		ST    X                  , R20                    ;update flag            (  2 clocks) 
 1602               	;		RJMP  _EXIT_SLP_TIME\@                            ;jump to exit           (  2 clocks) 
 1603               	;   _VAL_NOT_NULL\@:                                                                           
 1604               	;	    LD    R20                , X                      ;return sts             (  2 clocks) 
 1605               	;   _EXIT_SLP_TIME\@:                                                                          
 1606               	;       ADIW  R30                , 0x02                   ;add 2 with addr        (  2 clocks) 
 1607               	;		ADIW  R26                , 0x01                   ;add 1 with addr        (  2 clocks) 
 1608               	;   
 1609               	;	    CPI   R20                , TASK_READY             ;compare                (  1 clock ) 
 1610               	;       BREQ  _KER_CALC_PRIO\@                            ;calculate priority     (  2 clocks) 
 1611               	;       CPI   R20                , TASK_CONS_LAT          ;compare                (  1 clock ) 
 1612               	;		BREQ  _KER_CALC_PRIO\@                            ;calculate priority     (  2 clocks) 
 1613               	;		RJMP  _KER_SCH_NEXT\@                             ;next task id           (  2 clocks) 
 1614               	;
 1615               	;	_KER_CALC_PRIO\@:
 1616               	;	    LD    R20                , Y                      ;read priority          (  2 clocks) 
 1617               	;		CP    R20                , R18                    ;compare                (  1 clock ) 
 1618               	;       BRSH  _KER_SCH_NEXT\@                             ;next                   (  1 clock ) 
 1619               	;		ST    Y                  , R18                    ;store prio val         (  2 clocks) 
 1620               	;       MOV   R19                , R16                    ;store prio task_id     (  1 clock ) 
 1621               	;      
 1622               	;   _KER_SCH_NEXT\@:                                                                           
 1623               	;		INC   R16                                         ;increment by 1         (  1 clock ) 
 1624               	;		CP    R16                , R17                    ;compare with ntask     (  2 clocks) 
 1625               	;		BRLO  _KER_SCH_LOOP\@                             ;if task_id<ntask       (  2 clocks) 
 1626               	;	_KER_SCH_EXIT\@:                                                                           
 1627               	;		STS   KerBase+OFB_TID    , R19                    ;for test only          (  2 clocks) 
 1628               	;.endm                                                                                          
 1629               	;;===================================run scheduler end======================================;; 
DEFINED SYMBOLS
            kernel.S:30     *ABS*:000003e8 KER_TR
            kernel.S:31     *ABS*:00000003 KER_PRS
            kernel.S:32     *ABS*:00000082 KER_RLD
            kernel.S:33     *ABS*:00000080 KER_STK_SZ
            kernel.S:34     *ABS*:0000000a KER_MX_NTSK
            kernel.S:42     *ABS*:00000000 OFB_TICK0
            kernel.S:43     *ABS*:00000001 OFB_TICK1
            kernel.S:44     *ABS*:00000002 OFB_TICK2
            kernel.S:45     *ABS*:00000003 OFB_TICK3
            kernel.S:46     *ABS*:00000004 OFB_TICK4
            kernel.S:47     *ABS*:00000005 OFB_PRS
            kernel.S:48     *ABS*:00000006 OFB_RLD
            kernel.S:49     *ABS*:00000007 OFB_TID
            kernel.S:50     *ABS*:00000008 OFB_NTSK
            kernel.S:51     *ABS*:00000009 OFB_LPR
            kernel.S:52     *ABS*:0000000a OFB_PTID
            kernel.S:53     *ABS*:0000000b OFB_UTC
            kernel.S:54     *ABS*:0000000c OFB_UATC
            kernel.S:55     *ABS*:0000000d OFB_USAGE
            kernel.S:56     *ABS*:0000000e OFB_SLCFG
            kernel.S:57     *ABS*:00000000 OFM_MSPI
            kernel.S:58     *ABS*:00000002 OFM_MSPS
            kernel.S:66     *ABS*:00000000 TASK_BLOCKED
            kernel.S:67     *ABS*:00000001 TASK_READY
            kernel.S:68     *ABS*:00000002 TASK_EXECUTING
            kernel.S:69     *ABS*:00000003 TASK_SUSPENDED
            kernel.S:70     *ABS*:00000004 TASK_CONS_LAT
            kernel.S:71     *ABS*:00000000 SCH_MODE_HANDLER
            kernel.S:72     *ABS*:00000001 SCH_MODE_THREAD
            kernel.S:81     *ABS*:000000b6 SRASSR
            kernel.S:82     *ABS*:000000b4 SROCR2B
            kernel.S:83     *ABS*:000000b3 SROCR2A
            kernel.S:84     *ABS*:000000b2 SRTCNT2
            kernel.S:85     *ABS*:000000b1 SRTCCR2B
            kernel.S:86     *ABS*:000000b0 SRTCCR2A
            kernel.S:87     *ABS*:0000007c SRADMUX
            kernel.S:88     *ABS*:0000007a SRADCSRA
            kernel.S:89     *ABS*:00000070 SRTIMSK2
            kernel.S:90     *ABS*:00000061 SRCLKPR
            kernel.S:91     *ABS*:00000060 SRWDTCSR
            kernel.S:92     *ABS*:0000005f SRSREG
            kernel.S:93     *ABS*:0000005e SRSPH
            kernel.S:94     *ABS*:0000005d SRSPL
            kernel.S:95     *ABS*:00000055 SRMCUCR
            kernel.S:96     *ABS*:00000054 SRMCUSR
            kernel.S:97     *ABS*:00000053 SRSMCR
            kernel.S:98     *ABS*:00000050 SRACSR
            kernel.S:99     *ABS*:00000037 SRTIFR2
            kernel.S:101    *ABS*:0000003f IOSREG
            kernel.S:102    *ABS*:0000003e IOSPH
            kernel.S:103    *ABS*:0000003d IOSPL
            kernel.S:104    *ABS*:00000035 IOMCUCR
            kernel.S:105    *ABS*:00000034 IOMCUSR
            kernel.S:106    *ABS*:00000033 IOSMCR
            kernel.S:107    *ABS*:00000017 IOTIFR2
            kernel.S:118    .bss:00000000 KerBase
            kernel.S:121    .bss:00000010 KerPSP
            kernel.S:124    .bss:00000024 KerSSZ
            kernel.S:127    .bss:00000032 KerSchSts
            kernel.S:130    .bss:0000003c KerSchPr
            kernel.S:133    .bss:00000046 KerSchSlp
            kernel.S:136    .bss:0000005a KerStack
            kernel.S:1110   .text:000001e0 Kernel_Tick_Init
            kernel.S:1156   .text:0000027e Kernel_Task_Create
            kernel.S:1223   .text:0000036e Kernel_Start_Tasks
            kernel.S:1243   .text:000004a6 Kernel_Init
            kernel.S:1276   .text:00000504 Kernel_Task_Idle
            kernel.S:1296   .text:00000532 Kernel_Task_Sleep
            kernel.S:1329   .text:000006c8 Kernel_Task_Constant_Latency
            kernel.S:1356   .text:000006f4 Kernel_Task_Constant_Latency_Sleep
            kernel.S:1383   .text:00000876 Kernel_PreSleep_Hook
            kernel.S:1398   .text:0000087c Kernel_Clock_Prescale
            kernel.S:1417   .text:00000892 Kernel_Task_Sleep_Time_Get
            kernel.S:1439   .text:000008a6 Kernel_Task_Status_Get
            kernel.S:1459   .text:000008b6 Kernel_NTask_Get
            kernel.S:1473   .text:000008bc Kernel_Task_Prio_Get
            kernel.S:1494   .text:000008cc Kernel_Lowest_Prio_Get
            kernel.S:1508   .text:000008d2 Kernel_High_Prio_Task_ID_Get
            kernel.S:1523   .text:000008da Kernel_Abs_High_Prio_Task_ID_Get
            kernel.S:1537   .text:000008e0 Kernel_CPU_Usage_Get
            kernel.S:1552   .text:000008e6 Kernel_Tick_Val_Get
            kernel.S:1070   .text:00000000 __vector_7
            kernel.S:1077   .text:000000b0 _KER_SCH_LOOP8
            kernel.S:1077   .text:000000e6 _VAL_NULL9
            kernel.S:1077   .text:000000fa _VAL_NOT_NULL9
            kernel.S:1077   .text:0000010a _EXIT_SLP_TIME9
            kernel.S:1077   .text:00000114 _KER_CALC_PRIO8
            kernel.S:1077   .text:00000138 _KER_SCH_NEXT8
            kernel.S:1077   .text:00000148 _KER_SCH_EXIT8
            kernel.S:1078   .text:00000162 _KER_USG_TICK14
            kernel.S:1078   .text:0000017c _KER_USG_UTC_SV14
            kernel.S:1225   .text:0000037e _KER_SCH_LOOP32
            kernel.S:1225   .text:000003b4 _VAL_NULL33
            kernel.S:1225   .text:000003c8 _VAL_NOT_NULL33
            kernel.S:1225   .text:000003d8 _EXIT_SLP_TIME33
            kernel.S:1225   .text:000003e2 _KER_CALC_PRIO32
            kernel.S:1225   .text:00000406 _KER_SCH_NEXT32
            kernel.S:1225   .text:00000416 _KER_SCH_EXIT32
            kernel.S:1278   .text:0000050e _IDLE_LOOP
            kernel.S:1314   .text:000005c8 _KER_SCH_LOOP57
            kernel.S:1314   .text:000005fe _VAL_NULL58
            kernel.S:1314   .text:00000612 _VAL_NOT_NULL58
            kernel.S:1314   .text:00000622 _EXIT_SLP_TIME58
            kernel.S:1314   .text:0000062c _KER_CALC_PRIO57
            kernel.S:1314   .text:00000650 _KER_SCH_NEXT57
            kernel.S:1314   .text:00000660 _KER_SCH_EXIT57
            kernel.S:1368   .text:00000776 _KER_SCH_LOOP76
            kernel.S:1368   .text:000007ac _VAL_NULL77
            kernel.S:1368   .text:000007c0 _VAL_NOT_NULL77
            kernel.S:1368   .text:000007d0 _EXIT_SLP_TIME77
            kernel.S:1368   .text:000007da _KER_CALC_PRIO76
            kernel.S:1368   .text:000007fe _KER_SCH_NEXT76
            kernel.S:1368   .text:0000080e _KER_SCH_EXIT76

UNDEFINED SYMBOLS
Kernel_Tick_Val_Safely_Get
